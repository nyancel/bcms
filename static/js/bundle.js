"use strict";(()=>{var A="utilts-cache-stroage-key";function x(e){localStorage.setItem(A,JSON.stringify(e))}function q(){let e=localStorage.getItem(A);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("cache cant be parsed");return t}function O(e){let t=q();if(!t)return null;for(let n=0;n<t.length;n++)t[n].expires_at<d()&&t.splice(n,1);x(t);for(let n=0;n<t.length;n++)if(t[n].key==e)return t[n].item;return null}function N(e,t,n=3600){let r=q();r||(r=[]);let l={key:e,item:t,expires_at:d()+n};r.push(l),console.log(l),x(r)}function d(){return new Date().getTime()/1e3}async function m(e,t){let n=p();return n&&(t.auth_token=n.token.id),await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}async function y(e,t){let n=p();n&&t.append("auth_token",n?.token.id);let r=await fetch(e,{method:"POST",body:t});console.log(r);let l=await r.json();return console.log(l),l}async function f(e,t){console.log("getting smallest item from res");let n=`util_get_media_src_by_width-${e}-${t}`,r=O(n);if(r)return r;let l=await m("/media/fetch_media",{media_ID:e}),a=Math.pow(t,2),i=await Promise.all(l.instances.map(u=>({id:u.instance_id,resolution:u.x_dimension*u.y_dimension})));i=i.sort((u,E)=>u.resolution-E.resolution);let o=i[i.length-1].id;for(let u of i)if(u.resolution>a){o=u.id;break}let s=`/media/fetch_media_instance?instance_ID=${o}`;return N(n,s),s}var L="userts-local-user-token",H="userts-local-user-data";function p(){let e=localStorage.getItem(L),t=localStorage.getItem(H);if(!e||!t)return null;let n=JSON.parse(e),r=JSON.parse(t);return!n||!r?null:{token:n,user:r}}function U(){localStorage.removeItem(H),localStorage.removeItem(L)}function B(e){let t=JSON.stringify(e.token),n=JSON.stringify(e.user);return localStorage.setItem(L,t),localStorage.setItem(H,n),!0}function j(){let e=document.querySelector(".user-details-login-template"),t=document.querySelector(".user-details-profile-template"),n=document.querySelector(".user-details-container");return!e||!t||!n?null:{login_template:e,profile_template:t,details_container:n}}function I(){let e=document.querySelector("#user-register-first-name-input"),t=document.querySelector("#user-register-last-name-input"),n=document.querySelector("#user-register-email-input"),r=document.querySelector("#user-register-password-input"),l=document.querySelector("#user-register-password-repeat-input"),a=document.querySelector("#user-register-submitt-button"),i=document.querySelector("#user-signin-email-input"),o=document.querySelector("#user-signin-password-input"),s=document.querySelector("#user-signin-submitt-button");return!e||!t||!n||!r||!l||!a||!i||!o||!s?null:{registration:{email:n,first_name:e,last_name:t,password:r,repeat_password:l,submit:a},signin:{email:i,password:o,submit:s}}}function J(){let e=p();if(!e)throw new Error("No local user-data");m("/user/logout",{user_token:e.token.id}),U(),T()}function G(){let e=j();if(!e)throw new Error("could not load html elements");e.details_container.innerHTML="";let t=p();if(!t){let o=e.login_template.cloneNode(!0);e.details_container.appendChild(o.content);return}let r=e.profile_template.cloneNode(!0).content,l=r.querySelector("#user-profile-first-name");if(!l)throw new Error("fistname_element not found");l.innerHTML=t.user.first_name;let a=r.querySelector("#user-profile-last-name");if(!a)throw new Error("lastname_element not found");a.innerHTML=t.user.last_name;let i=r.querySelector("#user-profile-logout-button");if(!i)throw new Error("logout_button not found");i.onclick=()=>{J()},e.details_container.appendChild(r)}function P(e,t){let n=I();if(!n)throw new Error("input fields not initialized");if(!e){n.registration.submit.innerHTML=t??"invalid registration-data",n.registration.submit.classList.toggle("bg-green-600",!1),n.registration.submit.classList.toggle("bg-gray-600",!0);return}n.registration.submit.innerHTML="Register",n.registration.submit.classList.toggle("bg-gray-600",!1),n.registration.submit.classList.toggle("bg-green-600",!0)}function b(e){let t=!0,n="";return e.registration.password.value!=e.registration.repeat_password.value&&(t=!1,n="passwords dont match"),e.registration.first_name.value||(t=!1,n="missing first name"),e.registration.email.value||(t=!1,n="missing email"),e.registration.last_name.value||(t=!1,n="missing last name"),e.registration.password.value||(t=!1,n="missing password"),{valid:t,reason:n}}function R(e){if(!b(e).valid)throw new Error("inputs are not valid");(async()=>{let n=I();if(!n)throw new Error("input fields not initialized");if(!b(n).valid)throw new Error("inputs are not valid");let r={email:n.registration.email.value,password:n.registration.password.value,firstname:n.registration.first_name.value,lastname:n.registration.last_name.value},l=await m("/user/register_new_user",r);if(l.error)throw new Error(l.error);let a={email:r.email,password:r.password},i=await m("/user/login",a);if(i.error)throw new Error(i.error);B({user:l,token:i}),window.location.href="/"})()}function w(e){let{valid:t,reason:n}=b(e);P(t,n)}function z(){let e=I();if(!e)throw new Error("inputs not initialized");e.registration.email.oninput=()=>w(e),e.registration.first_name.oninput=()=>w(e),e.registration.last_name.oninput=()=>w(e),e.registration.password.oninput=()=>w(e),e.registration.repeat_password.oninput=()=>w(e),e.registration.submit.onclick=()=>R(e),w(e)}async function K(){let e=await m("/user/admin_test_creds",{}),t=await m("/user/who",{user_token:e.id});B({token:e,user:t})}function T(){K(),G(),window.location.pathname==="/signin"&&z()}var D="editor-ts-local-article";function c(){let e=localStorage.getItem(D);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("could not parse the local article, you fucked up somehow");return t}function _(e){let t=JSON.stringify(e);localStorage.setItem(D,t)}function W(){let e=p();if(!e)throw new Error("no user data found, not logged in");let t={author_id:e.user.id,content:[],description:"",last_changed:d(),id:void 0,title:""};return _(t),t}function Y(){let e=document.getElementById("log-article"),t=document.getElementById("add-paragraph"),n=document.getElementById("add-image"),r=document.getElementById("add-heading");return!e||!t||!n||!r?null:{log_button:e,add_paragraph_button:t,add_image_button:n,add_heading_button:r}}function F(){let e=document.getElementById("article-paragraph-template"),t=document.getElementById("article-image-template"),n=document.getElementById("article-heading-template");return!e||!t||!n?null:{paragraph:e,image:t,heading:n}}function $(){return document.getElementById("editor-container")}function Q(e){let t=window.open("/gallery-popup","popupWindow","width=600,height=400");window.receive_data=function(n){console.log(n);let r=c();if(!r)throw new Error("could not load artilce");let l=r.content[e];l.type==ArticleItemTypeEnum.image&&(l.src_id=n,_(r),g())}}function V(e){let t=document.createElement("input");t.type="file",t.accept="png, jpg, jpeg",t.multiple=!1,t.onchange=async()=>{let n=c();if(!n)throw new Error("could not load artilce");let r=n.content[e];if(r.type!=ArticleItemTypeEnum.image)return;let l=t.files;if(!l)return;let i=Array.from(l)[0];t.remove();let o=new FormData;o.append("media",i);let u=(await y("/media/upload_media",o)).data.results[0].key;r.src_id=u,n.last_changed=d(),_(n),g()},t.click()}function X(e,t,n){let r=e.querySelector(".image-display");if(!r)throw new Error("media-display not found");let l=n.content[t];if(l.type!=ArticleItemTypeEnum.image)throw new Error("item type is not image");if(!l.src_id){r.classList.toggle("hidden",!0);return}(async()=>{let i=n.content[t];if(i.type!=ArticleItemTypeEnum.image)throw new Error("item type is not image");if(!i.src_id)throw new Error("src_id not found");r.src=await f(i.src_id,e.clientWidth),r.classList.toggle("hidden",!1)})()}function M(e,t){console.log(e);let n=document.createElement("li"),r=e.cloneNode(!0);if(!r)throw new Error("could not clone template");let l=r.content;return n.appendChild(l),t.appendChild(n),n}function Z(e,t){let n=c();if(!n)throw new Error("could not load article");let r=e.querySelector(".paragraph-input");if(!r)throw new Error("Could not find textarea");let l=n.content[t];if(l.type!=ArticleItemTypeEnum.paragraph)throw new Error("Article item at index is not a paragraph");r.value=l.text,r.onchange=()=>{let a=c();if(!a)throw new Error("could not load article");let i=a.content[t];if(i.type!=ArticleItemTypeEnum.paragraph)throw new Error("Article item at index is not a paragraph");i.text=r.value,_(a)}}function ee(e,t){let n=c();if(!n)throw new Error("could not load article");let r=n.content[t];if(r.type!=ArticleItemTypeEnum.image)throw new Error("Article item at index is not a image");let l=e.querySelector(".image-alt-text-input");if(!l)throw new Error("could not find alt_text element");l.value=r.alt_text,l.onchange=()=>{let o=c();if(!o)throw new Error("could not load article");let s=o.content[t];if(s.type!=ArticleItemTypeEnum.image)throw new Error("Article item at index is not a image");s.alt_text=l.value,_(o)};let a=e.querySelector(".image-gallery-select"),i=e.querySelector(".image-gallery-upload");a&&(a.onclick=()=>Q(t)),i&&(i.onclick=()=>V(t))}function te(e,t){let n=e.querySelector(".delete-button");n&&(n.onclick=()=>{ne(t),g()});let r=e.querySelector(".move-up-button");r&&(r.onclick=()=>{C(t,-1),g()});let l=e.querySelector(".move-down-button");l&&(l.onclick=()=>{C(t,1),g()})}function g(){let e=c();if(!e)throw new Error("could not load article");let t=window.scrollY,n=$(),r=F();if(!n)throw new Error("Editor is not initialized");if(!r)throw new Error("templates did not load");n.innerHTML="";let l;for(let a=0;a<e.content.length;a++){switch(e.content[a].type){case ArticleItemTypeEnum.paragraph:l=M(r.paragraph,n),Z(l,a);break;case ArticleItemTypeEnum.image:l=M(r.image,n),X(l,a,e),ee(l,a);break;case ArticleItemTypeEnum.heading:l=M(r.heading,n);break;default:console.log("Item type in editor-render is unknown, skipping");continue}te(l,a)}_(e),requestAnimationFrame(()=>{window.scrollTo(0,t)})}function k(e){let t=c();if(!t)throw new Error("could not load artilce");let n=t.content.length,r;switch(e){case ArticleItemTypeEnum.paragraph:case ArticleItemTypeEnum.heading:r={type:e,text:"",index:n};break;case ArticleItemTypeEnum.image:r={type:e,alt_text:"",index:n,src_id:void 0};break}t.content.push(r),t.last_changed=d(),_(t),g()}function ne(e){let t=c();if(!t)throw new Error("could not load article");return t.content.splice(e,1),t.last_changed=d(),_(t),t}function C(e,t){let n=c();if(!n)throw new Error("could not load article");let r=e+t;if(r<0||r>=n.content.length)throw new Error("target position is out of bounds");let[l]=n.content.splice(e,1);return n.content.splice(r,0,l),n.last_changed=d(),_(n),n}function S(){if(!p()){window.location.href="/";return}let t=c();t||(t=W());let n=Y();if(!n)throw new Error("controll buttons not initialized");n.log_button.onclick=()=>console.log(t),n.add_paragraph_button.onclick=()=>k(ArticleItemTypeEnum.paragraph),n.add_image_button.onclick=()=>k(ArticleItemTypeEnum.image),n.add_heading_button.onclick=()=>k(ArticleItemTypeEnum.heading),g()}function re(){let e=document.getElementById("gallery-image-preview-template"),t=document.getElementById("gallery-image-display");return!t||!e?null:{image_preview_template:e,image_display:t}}async function le(){let e=await m("/media/fetch_all_media_metadata",{});if(e.error)throw new Error(e.error);let t=e;return t.length>1&&t.sort((n,r)=>r.creation_time-n.creation_time),t=t.filter(n=>n&&n.id),t}async function v(){let e=re();if(!e)throw new Error("Gallery HTML elements not initialized");let n=(await le()).map(async i=>({target:await f(i.id,e.image_display.clientWidth),media:i})),l=(await Promise.all(n)).map(i=>{let o=document.createElement("li"),u=e.image_preview_template.cloneNode(!0).content;o.appendChild(u);let E=o.querySelector("img");if(!E)throw new Error("could not find image element, something went wrong");return E.src=i.target,{entry:o,...i}}),a=await Promise.all(l);a.forEach(i=>{i.entry.onclick=()=>{window.opener.receive_data(i.media.id),window.close()}}),e.image_display.innerHTML="",a.forEach(i=>{e.image_display.appendChild(i.entry)})}function ae(){let e=document.getElementById("image-upload-source"),t=document.getElementById("gallery-image-preview-template"),n=document.getElementById("gallery-image-display"),r=document.getElementById("upload-image-button");return!e||!t||!n||!r?null:{input_source:e,image_preview_template:t,image_display:n,upload_button:r}}async function ie(e){let t=await m("/media/fetch_all_media_metadata",{});if(console.log(t),t.error)throw new Error(t.error);if(t.success==0)return null;let n=t;if(console.log(n),n.length<=0)throw new Error("no media found");n=n.filter(a=>a&&a.id);let r=n.map(async a=>{let i=await f(a.id,e.image_display.clientWidth);return{media:a,target_url:i}}),l=await Promise.all(r);return l.length>1&&l.sort((a,i)=>i.media.creation_time-a.media.creation_time),l}async function oe(e){let t=e.files;if(!t)throw new Error("no files attached to input source");let n=new FormData;for(let r=0;r<=t.length;r++)n.append("media",t[r]);await y("/media/upload_media",n),h(),e.value=""}async function se(e){let t=await ie(e);if(!t){e.image_display.innerHTML="";return}let n=t.map(l=>{let a=document.createElement("li"),o=e.image_preview_template.cloneNode(!0).content;a.append(o);let s=a.querySelector("img");if(!s)throw new Error("could not find img element");return s.src=l.target_url,{entry:a,media:l}}),r=await Promise.all(n);r.forEach(l=>{let a=l.entry.querySelector(".remove-image-button");if(!a)throw new Error("could not find remove media button");a.onclick=async()=>{await m("/media/update_media_metadata",{media_ID:l.media.media.id,is_unlisted:!0}),h()}}),e.image_display.innerHTML="",r.forEach(l=>e.image_display.appendChild(l.entry))}function h(){let e=ae();if(!e)throw new Error("html_elements not loaded");e.upload_button.onclick=()=>oe(e.input_source),se(e)}window.addEventListener("load",e=>{window.location.pathname==="/editor"&&S(),window.location.pathname==="/gallery-popup"&&v(),window.location.pathname==="/gallery"&&h(),T()});})();
//# sourceMappingURL=bundle.js.map
