"use strict";(()=>{var v="utilts-cache-stroage-key";function S(e){localStorage.setItem(v,JSON.stringify(e))}function x(){let e=localStorage.getItem(v);if(!e)return null;let n=JSON.parse(e);if(!n)throw new Error("cache cant be parsed");return n}function C(e){let n=x();if(!n)return null;for(let t=0;t<n.length;t++)n[t].expires_at<s()&&n.splice(t,1);S(n);for(let t=0;t<n.length;t++)if(n[t].key==e)return n[t].item;return null}function D(e,n,t=3600){let r=x();r||(r=[]);let a={key:e,item:n,expires_at:s()+t};r.push(a),console.log(a),S(r)}function s(){return new Date().getTime()/1e3}async function d(e,n){return await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json()}async function q(e,n){console.log("called stuff");let t=await fetch(e,{method:"POST",body:n});console.log(t);let r=await t.json();return console.log(r),r}async function A(e,n){console.log("getting smallest item from res");let t=`util_get_media_src_by_width-${e}-${n}`,r=C(t);if(r)return r;let a=await d("/media/fetch_media",{media_ID:e}),o=Math.pow(n,2),l=await Promise.all(a.instances.map(u=>({id:u.instance_id,resolution:u.x_dimension*u.y_dimension})));l=l.sort((u,O)=>u.resolution-O.resolution);let m=l[l.length-1].id;for(let u of l)if(u.resolution>o){m=u.id;break}let c=`/media/fetch_media_instance?instance_ID=${m}`;return D(t,c),c}var i={id:void 0,author_id:void 0,last_changed:void 0,content:[]},p={paragraph:document.getElementById("article-paragraph-template"),image:document.getElementById("article-image-template"),heading:document.getElementById("article-heading-template")},w=document.getElementById("editor-container");function B(e){let n=window.open("/gallery-popup","popupWindow","width=600,height=400");window.receive_data=function(t){if(!i.content)return;let r=i.content[e];r.type==1&&(r.src_id=t,g())}}function N(e){let n=document.createElement("input");n.type="file",n.accept="png, jpg, jpeg",n.multiple=!1,n.onchange=async()=>{if(!i.content)return;let t=i.content[e];if(t.type!=1)return;let r=n.files;if(!r)return;let o=Array.from(r)[0];n.remove();let l=new FormData;l.append("media",o);let c=(await q("/media/upload_media",l)).data.results[0].key;t.src_id=c,i.last_changed=s(),g()},n.click()}function j(e,n){let t=e.querySelector(".image-display");if(!t)throw new Error("media-display not found");if(!i.content)throw new Error("article content not initialized");let r=i.content[n];if(r.type!=1)throw new Error("item type is not image");if(!r.src_id){t.classList.toggle("hidden",!0);return}(async()=>{if(!i.content)throw new Error("article content not initialized");let o=i.content[n];if(o.type!=1)throw new Error("item type is not image");if(!o.src_id)throw new Error("src_id not found");t.src=await A(o.src_id,e.clientWidth),t.classList.toggle("hidden",!1)})()}function E(e){if(console.log(e),!w)throw new Error("Editor has not been initalized");let n=document.createElement("li"),t=e.cloneNode(!0);if(!t)throw new Error("could not clone template");let r=t.content;return n.appendChild(r),w.appendChild(n),n}function z(e,n){let t=e.querySelector(".paragraph-input");if(!t)throw new Error("Could not find textarea");let r=i.content[n];if(r.type!=0)throw new Error("Article item at index is not a paragraph");t.value=r.text,t.onchange=()=>{r.text=t.value}}function U(e,n){let t=e.querySelector(".image-alt-text-input");if(!t)throw new Error("could not find alt_text element");let r=i.content[n];if(r.type!=1)throw new Error("Article item at index is not a image");r.alt_text&&(t.value=r.alt_text),t.onchange=()=>{r.alt_text=t.value};let a=e.querySelector(".image-gallery-select"),o=e.querySelector(".image-gallery-upload");a&&(a.onclick=()=>B(n)),o&&(o.onclick=()=>N(n))}function J(e,n){let t=e.querySelector(".delete-button");t&&(t.onclick=()=>{R(n),g()});let r=e.querySelector(".move-up-button");r&&(r.onclick=()=>{P(n),g()});let a=e.querySelector(".move-down-button");a&&(a.onclick=()=>{K(n),g()})}function g(){let e=window.scrollY;if(!w)throw new Error("Editor is not initialized");if(!i)throw new Error("Article is not initialized");w.innerHTML="";let n;for(let t=0;t<i.content.length;t++){switch(i.content[t].type){case 0:if(!p.paragraph)throw new Error("paragraph template not initialized");n=E(p.paragraph),z(n,t);break;case 1:if(!p.image)throw new Error("image template not initialized");console.log("inserting image"),n=E(p.image),j(n,t),U(n,t);break;case 2:if(!p.heading)throw new Error("image template not initialized");n=E(p.heading);break;default:console.log("Item type in editor-render is unknown, skipping");continue}J(n,t)}requestAnimationFrame(()=>{window.scrollTo(0,e)})}function h(e){i.content||(i.content=[]);let n=i.content.length,t;switch(e){case 0:case 2:t={type:e,text:"",index:n};break;case 1:t={type:e,alt_text:"",index:n,src_id:void 0};break}i.content.push(t),i.last_changed=s(),g()}function R(e){i.content?.splice(e,1),i.last_changed=s()}function K(e){if(!i.content||e>=i.content.length-1)return;let n=i.content[e];i.content[e]=i.content[e+1],i.content[e+1]=n,i.content[e].index=e,i.content[e+1].index=e+1,i.last_changed=s()}function P(e){if(!i.content||e<1)return;let n=i.content[e];i.content[e]=i.content[e-1],i.content[e-1]=n,i.content[e].index=e,i.content[e-1].index=e-1,i.last_changed=s()}function Y(){console.log(i.content)}function y(){let e=document.getElementById("log-article");e&&(e.onclick=()=>Y());let n=document.getElementById("add-paragraph");n&&(n.onclick=()=>h(0));let t=document.getElementById("add-image");t&&(t.onclick=()=>h(1));let r=document.getElementById("add-heading");r&&(r.onclick=()=>h(2))}var L="userts-local-user-token",M="userts-local-user-data";function H(){let e=localStorage.getItem(L),n=localStorage.getItem(M);if(!e||!n)return null;let t=JSON.parse(e),r=JSON.parse(n);return!t||!r?null:{token:t,user:r}}function T(){localStorage.removeItem(M),localStorage.removeItem(L)}function b(e){let n=JSON.stringify(e.token),t=JSON.stringify(e.user);return localStorage.setItem(L,n),localStorage.setItem(M,t),!0}function F(){let e=document.querySelector(".user-details-login-template"),n=document.querySelector(".user-details-profile-template"),t=document.querySelector(".user-details-container");return!e||!n||!t?null:{login_template:e,profile_template:n,details_container:t}}function k(){let e=document.querySelector("#user-register-first-name-input"),n=document.querySelector("#user-register-last-name-input"),t=document.querySelector("#user-register-email-input"),r=document.querySelector("#user-register-password-input"),a=document.querySelector("#user-register-password-repeat-input"),o=document.querySelector("#user-register-submitt-button"),l=document.querySelector("#user-signin-email-input"),m=document.querySelector("#user-signin-password-input"),c=document.querySelector("#user-signin-submitt-button");return!e||!n||!t||!r||!a||!o||!l||!m||!c?null:{registration:{email:t,first_name:e,last_name:n,password:r,repeat_password:a,submit:o},signin:{email:l,password:m,submit:c}}}function W(){let e=H();if(!e)throw new Error("No local user-data");d("/user/logout",{user_token:e.token.id}),T(),f()}function $(){let e=F();if(!e)throw new Error("could not load html elements");e.details_container.innerHTML="";let n=H();if(!n){let m=e.login_template.cloneNode(!0);e.details_container.appendChild(m.content);return}let r=e.profile_template.cloneNode(!0).content,a=r.querySelector("#user-profile-first-name");if(!a)throw new Error("fistname_element not found");a.innerHTML=n.user.first_name;let o=r.querySelector("#user-profile-last-name");if(!o)throw new Error("lastname_element not found");o.innerHTML=n.user.last_name;let l=r.querySelector("#user-profile-logout-button");if(!l)throw new Error("logout_button not found");l.onclick=()=>{W()},e.details_container.appendChild(r)}function G(e,n){let t=k();if(!t)throw new Error("input fields not initialized");if(!e){t.registration.submit.innerHTML=n??"invalid registration-data",t.registration.submit.classList.toggle("bg-green-600",!1),t.registration.submit.classList.toggle("bg-gray-600",!0);return}t.registration.submit.innerHTML="Register",t.registration.submit.classList.toggle("bg-gray-600",!1),t.registration.submit.classList.toggle("bg-green-600",!0)}function I(e){let n=!0,t="";return e.registration.password.value!=e.registration.repeat_password.value&&(n=!1,t="passwords dont match"),e.registration.first_name.value||(n=!1,t="missing first name"),e.registration.email.value||(n=!1,t="missing email"),e.registration.last_name.value||(n=!1,t="missing last name"),e.registration.password.value||(n=!1,t="missing password"),{valid:n,reason:t}}function Q(e){if(!I(e).valid)throw new Error("inputs are not valid");(async()=>{let t=k();if(!t)throw new Error("input fields not initialized");if(!I(t).valid)throw new Error("inputs are not valid");let r={email:t.registration.email.value,password:t.registration.password.value,firstname:t.registration.first_name.value,lastname:t.registration.last_name.value},a=await d("/user/register_new_user",r);if(a.error)throw new Error(a.error);let o={email:r.email,password:r.password},l=await d("/user/login",o);if(l.error)throw new Error(l.error);b({user:a,token:l}),window.location.href="/"})()}function _(e){let{valid:n,reason:t}=I(e);G(n,t)}function V(){let e=k();if(!e)throw new Error("inputs not initialized");e.registration.email.oninput=()=>_(e),e.registration.first_name.oninput=()=>_(e),e.registration.last_name.oninput=()=>_(e),e.registration.password.oninput=()=>_(e),e.registration.repeat_password.oninput=()=>_(e),e.registration.submit.onclick=()=>Q(e),_(e)}async function X(){let e=H();if(!e)return null;if(s()>e.token.expires_at){T(),f();return}if(s()+600>e.token.expires_at){let t=await d("/user/refresh_token",{user_token:e.token.id});if(t.error)throw new Error(t.error);e.token=t,b(e)}let n=await d("/user/who",{user_token:e.token.id});if(n.error)if(n.error==="token invalid"){T(),f();return}else throw new Error(n.error);e.user=n,b(e)}function f(){X(),$(),window.location.pathname==="/signin"&&V()}window.addEventListener("load",e=>{window.location.pathname==="/editor"&&y(),f()});})();
//# sourceMappingURL=bundle.js.map
