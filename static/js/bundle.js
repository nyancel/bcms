"use strict";(()=>{var R="utilts-cache-stroage-key";function N(e){localStorage.setItem(R,JSON.stringify(e))}function O(){let e=localStorage.getItem(R);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("cache cant be parsed");return t}function X(e){let t=O();if(!t)return null;for(let n=0;n<t.length;n++)t[n].expires_at<p()&&t.splice(n,1);N(t);for(let n=0;n<t.length;n++)if(t[n].key==e)return t[n].item;return null}function Q(e,t,n=3600){let r=O();r||(r=[]);let l={key:e,item:t,expires_at:p()+n};r.push(l),console.log(l),N(r)}function p(){return new Date().getTime()/1e3}async function u(e,t){let n=g();return n&&(t.auth_token=n.token.id),await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}async function y(e,t){let n=g();n&&t.append("auth_token",n?.token.id);let r=await fetch(e,{method:"POST",body:t});console.log(r);let l=await r.json();return console.log(l),l}async function E(e,t){console.log("getting smallest item from res");let n=`util_get_media_src_by_width-${e}-${t}`,r=X(n);if(r)return r;let l=await u("/media/fetch_media",{media_ID:e}),i=Math.pow(t,2),a=await Promise.all(l.instances.map(m=>({id:m.instance_id,resolution:m.x_dimension*m.y_dimension})));a=a.sort((m,d)=>m.resolution-d.resolution);let o=a[a.length-1].id;for(let m of a)if(m.resolution>i){o=m.id;break}let s=`/media/fetch_media_instance?instance_ID=${o}`;return Q(n,s),s}var H="userts-local-user-token",b="userts-local-user-data";function g(){let e=localStorage.getItem(H),t=localStorage.getItem(b);if(!e||!t)return null;let n=JSON.parse(e),r=JSON.parse(t);return!n||!r?null:{token:n,user:r}}function V(){localStorage.removeItem(b),localStorage.removeItem(H)}function U(e){let t=JSON.stringify(e.token),n=JSON.stringify(e.user);return localStorage.setItem(H,t),localStorage.setItem(b,n),!0}function Z(){let e=document.querySelector(".user-details-login-template"),t=document.querySelector(".user-details-profile-template"),n=document.querySelector(".user-details-container");return!e||!t||!n?null:{login_template:e,profile_template:t,details_container:n}}function S(){let e=document.querySelector("#user-register-first-name-input"),t=document.querySelector("#user-register-last-name-input"),n=document.querySelector("#user-register-email-input"),r=document.querySelector("#user-register-password-input"),l=document.querySelector("#user-register-password-repeat-input"),i=document.querySelector("#user-register-submitt-button"),a=document.querySelector("#user-signin-email-input"),o=document.querySelector("#user-signin-password-input"),s=document.querySelector("#user-signin-submitt-button");return!e||!t||!n||!r||!l||!i||!a||!o||!s?null:{registration:{email:n,first_name:e,last_name:t,password:r,repeat_password:l,submit:i},signin:{email:a,password:o,submit:s}}}function ee(){let e=g();if(!e)throw new Error("No local user-data");u("/user/logout",{user_token:e.token.id}),V(),L()}function te(){let e=Z();if(!e)throw new Error("could not load html elements");e.details_container.innerHTML="";let t=g();if(!t){let o=e.login_template.cloneNode(!0);e.details_container.appendChild(o.content);return}let r=e.profile_template.cloneNode(!0).content,l=r.querySelector("#user-profile-first-name");if(!l)throw new Error("fistname_element not found");l.innerHTML=t.user.first_name;let i=r.querySelector("#user-profile-last-name");if(!i)throw new Error("lastname_element not found");i.innerHTML=t.user.last_name;let a=r.querySelector("#user-profile-logout-button");if(!a)throw new Error("logout_button not found");a.onclick=()=>{ee()},e.details_container.appendChild(r)}function ne(e,t){let n=S();if(!n)throw new Error("input fields not initialized");if(!e){n.registration.submit.innerHTML=t??"invalid registration-data",n.registration.submit.classList.toggle("bg-green-600",!1),n.registration.submit.classList.toggle("bg-gray-600",!0);return}n.registration.submit.innerHTML="Register",n.registration.submit.classList.toggle("bg-gray-600",!1),n.registration.submit.classList.toggle("bg-green-600",!0)}function M(e){let t=!0,n="";return e.registration.password.value!=e.registration.repeat_password.value&&(t=!1,n="passwords dont match"),e.registration.first_name.value||(t=!1,n="missing first name"),e.registration.email.value||(t=!1,n="missing email"),e.registration.last_name.value||(t=!1,n="missing last name"),e.registration.password.value||(t=!1,n="missing password"),{valid:t,reason:n}}function re(e){if(!M(e).valid)throw new Error("inputs are not valid");(async()=>{let n=S();if(!n)throw new Error("input fields not initialized");if(!M(n).valid)throw new Error("inputs are not valid");let r={email:n.registration.email.value,password:n.registration.password.value,firstname:n.registration.first_name.value,lastname:n.registration.last_name.value},l=await u("/user/register_new_user",r);if(l.error)throw new Error(l.error);let i={email:r.email,password:r.password},a=await u("/user/login",i);if(a.error)throw new Error(a.error);U({user:l,token:a}),window.location.href="/"})()}function h(e){let{valid:t,reason:n}=M(e);ne(t,n)}function le(){let e=S();if(!e)throw new Error("inputs not initialized");e.registration.email.oninput=()=>h(e),e.registration.first_name.oninput=()=>h(e),e.registration.last_name.oninput=()=>h(e),e.registration.password.oninput=()=>h(e),e.registration.repeat_password.oninput=()=>h(e),e.registration.submit.onclick=()=>re(e),h(e)}async function ie(){let e=await u("/user/admin_test_creds",{}),t=await u("/user/who",{user_token:e.id});U({token:e,user:t})}function L(){ie(),te(),window.location.pathname==="/signin"&&le()}var j="editor-ts-local-article";function c(){let e=localStorage.getItem(j);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("could not parse the local article, you fucked up somehow");return t}function _(e){let t=JSON.stringify(e);localStorage.setItem(j,t)}function ae(){let e=g();if(!e)throw new Error("no user data found, not logged in");let t={author_id:e.user.id,content:[],description:"",last_changed:p(),id:void 0,title:""};return _(t),t}function oe(){let e=document.getElementById("log-article"),t=document.getElementById("add-paragraph"),n=document.getElementById("add-image"),r=document.getElementById("add-heading");return!e||!t||!n||!r?null:{log_button:e,add_paragraph_button:t,add_image_button:n,add_heading_button:r}}function se(){let e=document.getElementById("article-paragraph-template"),t=document.getElementById("article-image-template"),n=document.getElementById("article-heading-template");return!e||!t||!n?null:{paragraph:e,image:t,heading:n}}function me(){return document.getElementById("editor-container")}function ue(e){let t=window.open("/gallery-popup","popupWindow","width=600,height=400");window.receive_data=function(n){console.log(n);let r=c();if(!r)throw new Error("could not load artilce");let l=r.content[e];l.type==ArticleItemTypeEnum.image&&(l.src_id=n,_(r),f())}}function ce(e){let t=document.createElement("input");t.type="file",t.accept="png, jpg, jpeg",t.multiple=!1,t.onchange=async()=>{let n=c();if(!n)throw new Error("could not load artilce");let r=n.content[e];if(r.type!=ArticleItemTypeEnum.image)return;let l=t.files;if(!l)return;let a=Array.from(l)[0];t.remove();let o=new FormData;o.append("media",a);let m=(await y("/media/upload_media",o)).data.results[0].key;r.src_id=m,n.last_changed=p(),_(n),f()},t.click()}function de(e,t,n){let r=e.querySelector(".image-display");if(!r)throw new Error("media-display not found");let l=n.content[t];if(l.type!=ArticleItemTypeEnum.image)throw new Error("item type is not image");if(!l.src_id){r.classList.toggle("hidden",!0);return}(async()=>{let a=n.content[t];if(a.type!=ArticleItemTypeEnum.image)throw new Error("item type is not image");if(!a.src_id)throw new Error("src_id not found");r.src=await E(a.src_id,e.clientWidth),r.classList.toggle("hidden",!1)})()}function I(e,t){console.log(e);let n=document.createElement("li"),r=e.cloneNode(!0);if(!r)throw new Error("could not clone template");let l=r.content;return n.appendChild(l),t.appendChild(n),n}function pe(e,t){let n=c();if(!n)throw new Error("could not load article");let r=e.querySelector(".paragraph-input");if(!r)throw new Error("Could not find textarea");let l=n.content[t];if(l.type!=ArticleItemTypeEnum.paragraph)throw new Error("Article item at index is not a paragraph");r.value=l.text,r.onchange=()=>{let i=c();if(!i)throw new Error("could not load article");let a=i.content[t];if(a.type!=ArticleItemTypeEnum.paragraph)throw new Error("Article item at index is not a paragraph");a.text=r.value,_(i)}}function _e(e,t){let n=c();if(!n)throw new Error("could not load article");let r=n.content[t];if(r.type!=ArticleItemTypeEnum.image)throw new Error("Article item at index is not a image");let l=e.querySelector(".image-alt-text-input");if(!l)throw new Error("could not find alt_text element");l.value=r.alt_text,l.onchange=()=>{let o=c();if(!o)throw new Error("could not load article");let s=o.content[t];if(s.type!=ArticleItemTypeEnum.image)throw new Error("Article item at index is not a image");s.alt_text=l.value,_(o)};let i=e.querySelector(".image-gallery-select"),a=e.querySelector(".image-gallery-upload");i&&(i.onclick=()=>ue(t)),a&&(a.onclick=()=>ce(t))}function ge(e,t){let n=e.querySelector(".delete-button");n&&(n.onclick=()=>{fe(t),f()});let r=e.querySelector(".move-up-button");r&&(r.onclick=()=>{P(t,-1),f()});let l=e.querySelector(".move-down-button");l&&(l.onclick=()=>{P(t,1),f()})}function f(){let e=c();if(!e)throw new Error("could not load article");let t=window.scrollY,n=me(),r=se();if(!n)throw new Error("Editor is not initialized");if(!r)throw new Error("templates did not load");n.innerHTML="";let l;for(let i=0;i<e.content.length;i++){switch(e.content[i].type){case ArticleItemTypeEnum.paragraph:l=I(r.paragraph,n),pe(l,i);break;case ArticleItemTypeEnum.image:l=I(r.image,n),de(l,i,e),_e(l,i);break;case ArticleItemTypeEnum.heading:l=I(r.heading,n);break;default:console.log("Item type in editor-render is unknown, skipping");continue}ge(l,i)}_(e),requestAnimationFrame(()=>{window.scrollTo(0,t)})}function A(e){let t=c();if(!t)throw new Error("could not load artilce");let n=t.content.length,r;switch(e){case ArticleItemTypeEnum.paragraph:case ArticleItemTypeEnum.heading:r={type:e,text:"",index:n};break;case ArticleItemTypeEnum.image:r={type:e,alt_text:"",index:n,src_id:void 0};break}t.content.push(r),t.last_changed=p(),_(t),f()}function fe(e){let t=c();if(!t)throw new Error("could not load article");return t.content.splice(e,1),t.last_changed=p(),_(t),t}function P(e,t){let n=c();if(!n)throw new Error("could not load article");let r=e+t;if(r<0||r>=n.content.length)throw new Error("target position is out of bounds");let[l]=n.content.splice(e,1);return n.content.splice(r,0,l),n.last_changed=p(),_(n),n}function k(){if(!g()){window.location.href="/";return}let t=c();t||(t=ae());let n=oe();if(!n)throw new Error("controll buttons not initialized");n.log_button.onclick=()=>console.log(t),n.add_paragraph_button.onclick=()=>A(ArticleItemTypeEnum.paragraph),n.add_image_button.onclick=()=>A(ArticleItemTypeEnum.image),n.add_heading_button.onclick=()=>A(ArticleItemTypeEnum.heading),f()}function we(){let e=document.getElementById("gallery-image-preview-template"),t=document.getElementById("gallery-image-display");return!t||!e?null:{image_preview_template:e,image_display:t}}async function Ee(){let e=await u("/media/fetch_all_media_metadata",{});if(e.error)throw new Error(e.error);let t=e;return t.length>1&&t.sort((n,r)=>r.creation_time-n.creation_time),t=t.filter(n=>n&&n.id),t}async function v(){let e=we();if(!e)throw new Error("Gallery HTML elements not initialized");let n=(await Ee()).map(async a=>({target:await E(a.id,e.image_display.clientWidth),media:a})),l=(await Promise.all(n)).map(a=>{let o=document.createElement("li"),m=e.image_preview_template.cloneNode(!0).content;o.appendChild(m);let d=o.querySelector("img");if(!d)throw new Error("could not find image element, something went wrong");return d.src=a.target,{entry:o,...a}}),i=await Promise.all(l);i.forEach(a=>{a.entry.onclick=()=>{window.opener.receive_data(a.media.id),window.close()}}),e.image_display.innerHTML="",i.forEach(a=>{e.image_display.appendChild(a.entry)})}function he(){let e=document.getElementById("image-upload-source"),t=document.getElementById("gallery-image-preview-template"),n=document.getElementById("gallery-image-display"),r=document.getElementById("upload-image-button");return!e||!t||!n||!r?null:{input_source:e,image_preview_template:t,image_display:n,upload_button:r}}async function Te(e){let t=await u("/media/fetch_all_media_metadata",{});if(console.log(t),t.error)throw new Error(t.error);if(t.success==0)return null;let n=t;if(console.log(n),n.length<=0)throw new Error("no media found");n=n.filter(i=>i&&i.id);let r=n.map(async i=>{let a=await E(i.id,e.image_display.clientWidth);return{media:i,target_url:a}}),l=await Promise.all(r);return l.length>1&&l.sort((i,a)=>a.media.creation_time-i.media.creation_time),l}async function ye(e){let t=e.files;if(!t)throw new Error("no files attached to input source");let n=new FormData;for(let r=0;r<=t.length;r++)n.append("media",t[r]);await y("/media/upload_media",n),T(),e.value=""}async function Le(e){let t=await Te(e);if(!t){e.image_display.innerHTML="";return}let n=t.map(l=>{let i=document.createElement("li"),o=e.image_preview_template.cloneNode(!0).content;i.append(o);let s=i.querySelector("img");if(!s)throw new Error("could not find img element");return s.src=l.target_url,{entry:i,media:l}}),r=await Promise.all(n);r.forEach(l=>{let i=l.entry.querySelector(".remove-image-button");if(!i)throw new Error("could not find remove media button");i.onclick=async()=>{await u("/media/update_media_metadata",{media_ID:l.media.media.id,is_unlisted:!0}),T()}}),e.image_display.innerHTML="",r.forEach(l=>e.image_display.appendChild(l.entry))}function T(){let e=he();if(!e)throw new Error("html_elements not loaded");e.upload_button.onclick=()=>ye(e.input_source),Le(e)}var G=document.querySelector("#list-article-template"),q=document.querySelector("#list-article-display");function x(){J()}function Me(e){if(!q)throw new Error("Display list_article not found");if(!G)throw new Error("Template is not found");q.innerHTML="";for(let t=0;t<e.length;t++){let r=G.cloneNode(!0).content,l=r.querySelector(".list-article-title");if(!l)throw new Error("title not found");if(l.innerHTML=e[t].title,e[t].image.src_id){let s=r.querySelector(".list-article-image"),m=e[t].image.src_id;s&&(s.src=m)}let i=r.querySelector(".list-article-desc");if(!i)throw new Error("title not found");i.innerHTML=e[t].desc;let a=r.querySelector(".list-article-user_id");if(!a)throw new Error("title not found");a.innerHTML=e[t].user_id;let o=r.querySelector(".list-article-link");if(!o)throw new Error("entry element not found");o.onclick=()=>{window.location.href=`/view?article-id=${e[t].id}`},q.appendChild(r)}}async function J(){let e=await u("/article/list_all_articles",{});if("error"in e)throw new Error(e.error);Me(e),window.setTimeout(()=>{J()},1e3*60*10)}var w=document.querySelector("#article-display"),Y=document.querySelector("#article-image"),$=document.querySelector("#article-title"),z=document.querySelector("#article-metadata"),K=document.querySelector("#article-desc"),W=document.querySelector("#article-text");function C(){let t=new URLSearchParams(window.location.search).get("article-id");if(t==null)throw new Error("Article not found!");be(t)}function He(e){if(!w)throw new Error("Display_article not found");if(!Y)throw new Error("Template IMAGE is not found");if(!$)throw new Error("Template TITLE is not found");if(!z)throw new Error("Template METADATA is not found");if(!K)throw new Error("Template DESC is not found");if(!W)throw new Error("Template TEXT is not found");w.innerHTML="";let t=$.cloneNode(!0),n=t.content,r=n.querySelector(".article-title");if(!r)throw new Error("title not found");r.innerHTML=e.title,w.append(n),t=K.cloneNode(!0),n=t.content;let l=n.querySelector(".article-desc");if(!l)throw new Error("description not found!");l.innerHTML=e.desc,w.append(n),t=z.cloneNode(!0),n=t.content;let i=n.querySelector(".article-timestamp");if(!i)throw new Error("created timestamp not found");let a=new Date(0);a.setUTCSeconds(e.timestamp),i.innerHTML=`Skrevet: ${a.toLocaleString()}`;let o=n.querySelector(".article-update-timestamp");if(!o)throw new Error("update timestamp not found");let s=new Date(0);s.setUTCSeconds(e.update_timestamp),o.innerHTML=`Oppdatert: ${s.toLocaleString()}`;let m=n.querySelector(".article-author");if(!m)throw new Error("author not found");m.innerHTML=`Skrevet av ${e.user_id}`,w.append(n);for(let d=0;d<e.body.length;d++)switch(e.body[d].type){case"image":t=Y.cloneNode(!0),n=t.content;let D=n.querySelector(".article-image"),F=e.body[d].src_id;D&&(D.src=F),w.appendChild(n);break;case"paragraph":t=W.cloneNode(!0),n=t.content;let B=n.querySelector(".article-text");if(!B)throw new Error("text not found");B.innerHTML=e.body[d].text,w.appendChild(n);break}}async function be(e){let t=await u("/article/get_article",{id:e});if("error"in t)throw new Error(t.error);console.log(t),He(t)}window.addEventListener("load",e=>{window.location.pathname==="/editor"&&k(),window.location.pathname==="/gallery-popup"&&v(),window.location.pathname==="/gallery"&&T(),window.location.pathname==="/view"&&C(),window.location.pathname==="/"&&x(),L()});})();
//# sourceMappingURL=bundle.js.map
