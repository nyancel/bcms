"use strict";(()=>{var s=[],I="C_CACHE_KEY";function y(){localStorage.setItem(I,JSON.stringify(s))}function b(){let t=localStorage.getItem(I);if(!t)return;let e=JSON.parse(t);e&&(s=e)}function v(t){b();for(let e=0;e<s.length;e++)s[e].expires_at<l()&&s.splice(e,1);y();for(let e=0;e<s.length;e++)if(s[e].key==t)return s[e].item;return null}function P(t,e){b();let n={key:t,item:e,expires_at:l()+3600};s.push(n),console.log(n),y()}function l(){return new Date().getTime()/1e3}async function d(t,e){return await(await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json()}async function L(t,e){console.log("called stuff");let n=await fetch(t,{method:"POST",body:e});console.log(n);let r=await n.json();return console.log(r),r}async function U(t,e){console.log("getting smallest item from res");let n=`util_get_media_src_by_width${t}${e}`,r=v(n);if(r)return console.log("cache hit"),r;let o=await d("/media/fetch_media",{media_ID:t}),a=Math.pow(e,2),u=await Promise.all(o.instances.map(m=>({id:m.instance_id,resolution:m.x_dimension*m.y_dimension})));u=u.sort((m,H)=>m.resolution-H.resolution);let w=u[u.length-1].id;for(let m of u)if(m.resolution>a){w=m.id;break}let _=`/media/fetch_media_instance?instance_ID=${w}`;return P(n,_),_}var i={id:void 0,author_id:void 0,last_changed:void 0,content:[]},c={paragraph:document.getElementById("article-paragraph-template"),image:document.getElementById("article-image-template"),heading:document.getElementById("article-heading-template")},E=document.getElementById("editor-container");function R(t){let e=window.open("/gallery-popup","popupWindow","width=600,height=400");window.receive_data=function(n){if(!i.content)return;let r=i.content[t];r.type==1&&(r.src_id=n,p())}}function x(t){let e=document.createElement("input");e.type="file",e.accept="png, jpg, jpeg",e.multiple=!1,e.onchange=async()=>{if(!i.content)return;let n=i.content[t];if(n.type!=1)return;let r=e.files;if(!r)return;let a=Array.from(r)[0];e.remove();let u=new FormData;u.append("media",a);let _=(await L("/media/upload_media",u)).data.results[0].key;n.src_id=_,i.last_changed=l(),p()},e.click()}function q(t,e){let n=t.querySelector(".image-display");if(!n)throw new Error("media-display not found");if(!i.content)throw new Error("article content not initialized");let r=i.content[e];if(r.type!=1)throw new Error("item type is not image");if(!r.src_id){n.classList.toggle("hidden",!0);return}(async()=>{if(!i.content)throw new Error("article content not initialized");let a=i.content[e];if(a.type!=1)throw new Error("item type is not image");if(!a.src_id)throw new Error("src_id not found");n.src=await U(a.src_id,t.clientWidth),n.classList.toggle("hidden",!1)})()}function T(t){if(console.log(t),!E)throw new Error("Editor has not been initalized");let e=document.createElement("li"),n=t.cloneNode(!0);if(!n)throw new Error("could not clone template");let r=n.content;return e.appendChild(r),E.appendChild(e),e}function A(t,e){let n=t.querySelector(".paragraph-input");if(!n)throw new Error("Could not find textarea");let r=i.content[e];if(r.type!=0)throw new Error("Article item at index is not a paragraph");n.value=r.text,n.onchange=()=>{r.text=n.value}}function C(t,e){let n=t.querySelector(".image-alt-text-input");if(!n)throw new Error("could not find alt_text element");let r=i.content[e];if(r.type!=1)throw new Error("Article item at index is not a image");r.alt_text&&(n.value=r.alt_text),n.onchange=()=>{r.alt_text=n.value};let o=t.querySelector(".image-gallery-select"),a=t.querySelector(".image-gallery-upload");o&&(o.onclick=()=>R(e)),a&&(a.onclick=()=>x(e))}function z(t,e){let n=t.querySelector(".delete-button");n&&(n.onclick=()=>{O(e),p()});let r=t.querySelector(".move-up-button");r&&(r.onclick=()=>{D(e),p()});let o=t.querySelector(".move-down-button");o&&(o.onclick=()=>{B(e),p()})}function p(){let t=window.scrollY;if(!E)throw new Error("Editor is not initialized");if(!i)throw new Error("Article is not initialized");E.innerHTML="";let e;for(let n=0;n<i.content.length;n++){switch(i.content[n].type){case 0:if(!c.paragraph)throw new Error("paragraph template not initialized");e=T(c.paragraph),A(e,n);break;case 1:if(!c.image)throw new Error("image template not initialized");console.log("inserting image"),e=T(c.image),q(e,n),C(e,n);break;case 2:if(!c.heading)throw new Error("image template not initialized");e=T(c.heading);break;default:console.log("Item type in editor-render is unknown, skipping");continue}z(e,n)}requestAnimationFrame(()=>{window.scrollTo(0,t)})}function S(t){i.content||(i.content=[]);let e=i.content.length,n;switch(t){case 0:case 2:n={type:t,text:"",index:e};break;case 1:n={type:t,alt_text:"",index:e,src_id:void 0};break}i.content.push(n),i.last_changed=l(),p()}function O(t){i.content?.splice(t,1),i.last_changed=l()}function B(t){if(!i.content||t>=i.content.length-1)return;let e=i.content[t];i.content[t]=i.content[t+1],i.content[t+1]=e,i.content[t].index=t,i.content[t+1].index=t+1,i.last_changed=l()}function D(t){if(!i.content||t<1)return;let e=i.content[t];i.content[t]=i.content[t-1],i.content[t-1]=e,i.content[t].index=t,i.content[t-1].index=t-1,i.last_changed=l()}function j(){console.log(i.content)}function g(){let t=document.getElementById("log-article");t&&(t.onclick=()=>j());let e=document.getElementById("add-paragraph");e&&(e.onclick=()=>S(0));let n=document.getElementById("add-image");n&&(n.onclick=()=>S(1));let r=document.getElementById("add-heading");r&&(r.onclick=()=>S(2))}var M="userts-local-user-token",k="userts-local-user-data";function J(){let t=localStorage.getItem(M),e=localStorage.getItem(k);if(!t||!e)return null;let n=JSON.parse(t),r=JSON.parse(e);return!n||!r?null:{token:n,user:r}}function K(){localStorage.removeItem(k),localStorage.removeItem(M)}function Y(){let t=J();if(!t)throw new Error("No local user-data");d("/user/logout",{user_token:t.token.id}),K(),g()}function F(){if(!ELEMENTS.details_container)throw new Error("details container not initialized");if(!ELEMENTS.login_template)throw new Error("logintemplate not initialized");if(!ELEMENTS.profile_template)throw new Error("profile template not initialized");if(!USER.user){ELEMENTS.details_container.innerHTML="";let a=ELEMENTS.login_template.cloneNode(!0);ELEMENTS.details_container.appendChild(a.content);return}ELEMENTS.details_container.innerHTML="";let e=ELEMENTS.profile_template.cloneNode(!0).content,n=e.querySelector("#user-profile-first-name");if(!n)throw new Error("fistname_element not found");n.innerHTML=USER.user.first_name;let r=e.querySelector("#user-profile-last-name");if(!r)throw new Error("lastname_element not found");r.innerHTML=USER.user.last_name;let o=e.querySelector("#user-profile-logout-button");if(!o)throw new Error("logout_button not found");o.onclick=()=>{Y()},ELEMENTS.details_container.appendChild(e)}function W(t,e){if(!INPUTS.registration.submit)throw new Error("registration-submit button not found");t||(INPUTS.registration.submit.innerHTML=e??"invalid registration_data",INPUTS.registration.submit.classList.toggle("bg-green-600",!1),INPUTS.registration.submit.classList.toggle("bg-gray-600",!0)),t&&(INPUTS.registration.submit.innerHTML="Register",INPUTS.registration.submit.classList.toggle("bg-gray-600",!1),INPUTS.registration.submit.classList.toggle("bg-green-600",!0))}function f(){if(!INPUTS.registration.password)throw new Error("registration password field not found");if(!INPUTS.registration.repeat_password)throw new Error("repeat_passowrd registration field not found");if(!INPUTS.registration.email)throw new Error("email registration field not found");if(!INPUTS.registration.first_name)throw new Error("first_name registration field not found");if(!INPUTS.registration.last_name)throw new Error("last_name registration field not found");let t=!0,e;INPUTS.registration.password.value!=INPUTS.registration.repeat_password.value&&(t=!1,e="passwords dont match"),INPUTS.registration.first_name.value||(t=!1,e="missing first name"),INPUTS.registration.email.value||(t=!1,e="missing email"),INPUTS.registration.last_name.value||(t=!1,e="missing last name"),INPUTS.registration.password.value||(t=!1,e="missing password"),INPUTS.registration.valid_inputs=t,W(t,e)}function $(){if(!INPUTS.registration.valid_inputs)return;(async()=>{if(!INPUTS.registration.email)throw new Error("email value not supplied");if(!INPUTS.registration.password)throw new Error("password value not supplied");if(!INPUTS.registration.first_name)throw new Error("first name value not supplied");if(!INPUTS.registration.last_name)throw new Error("last name value not supplied");let e={email:INPUTS.registration.email.value,password:INPUTS.registration.password.value,firstname:INPUTS.registration.first_name.value,lastname:INPUTS.registration.last_name.value},n=await d("/user/register_new_user",e);if(n.error)throw new Error(n.error);USER.user=n;let r={email:e.email,password:e.password},o=await d("/user/login",r);if(o.error)throw new Error(o.error);USER.token=o,user_save_local(),window.location.href="/"})()}function G(){if(!INPUTS.registration.email)throw new Error("email input for registration not initalized");if(!INPUTS.registration.first_name)throw new Error("first_name input for registration not initalized");if(!INPUTS.registration.last_name)throw new Error("last_name input for registration not initalized");if(!INPUTS.registration.password)throw new Error("password input for registration not initalized");if(!INPUTS.registration.repeat_password)throw new Error("repeate_password input for registration not initalized");if(!INPUTS.registration.submit)throw new Error("submit input for registration not initalized");INPUTS.registration.email.oninput=()=>{f()},INPUTS.registration.first_name.oninput=()=>{f()},INPUTS.registration.last_name.oninput=()=>{f()},INPUTS.registration.password.oninput=()=>{f()},INPUTS.registration.repeat_password.oninput=()=>{f()},f(),INPUTS.registration.submit.onclick=()=>{$()}}function Q(){G()}async function N(){if(!USER.token)return;if(l()>USER.token.expires_at){USER.token=void 0,USER.user=void 0,user_save_local();return}if(l()+600>USER.token.expires_at){let n=await d("/user/refresh_token",{user_token:USER.token.id});if(n.error)throw new Error(n.error);USER.token=n}if(!USER.token)throw new Error("user token not found, i dont know how but you fucked up");let t=await d("/user/who",{user_token:USER.token.id});if(t.error)if(t.error==="token invalid"){USER.user=void 0,USER.token=void 0,user_save_local(),g();return}else throw new Error(t.error);USER.token=t;let e=USER.token.expires_at-l();e=e-60,e=e*1e3,window.setTimeout(()=>{N()},e),user_save_local()}function h(){N(),ELEMENTS.details_container&&F(),window.location.pathname==="/signin"&&Q()}window.addEventListener("load",t=>{window.location.pathname==="/editor"&&g(),h()});})();
//# sourceMappingURL=bundle.js.map
