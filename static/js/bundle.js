"use strict";(()=>{var c=[],S="C_CACHE_KEY";function x(){localStorage.setItem(S,JSON.stringify(c))}function q(){let e=localStorage.getItem(S);if(!e)return;let t=JSON.parse(e);t&&(c=t)}function D(e){q();for(let t=0;t<c.length;t++)c[t].expires_at<s()&&c.splice(t,1);x();for(let t=0;t<c.length;t++)if(c[t].key==e)return c[t].item;return null}function B(e,t){q();let n={key:e,item:t,expires_at:s()+3600};c.push(n),console.log(n),x()}function s(){return new Date().getTime()/1e3}async function p(e,t){return await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}async function A(e,t){console.log("called stuff");let n=await fetch(e,{method:"POST",body:t});console.log(n);let r=await n.json();return console.log(r),r}async function C(e,t){console.log("getting smallest item from res");let n=`util_get_media_src_by_width${e}${t}`,r=D(n);if(r)return console.log("cache hit"),r;let a=await p("/media/fetch_media",{media_ID:e}),o=Math.pow(t,2),l=await Promise.all(a.instances.map(u=>({id:u.instance_id,resolution:u.x_dimension*u.y_dimension})));l=l.sort((u,O)=>u.resolution-O.resolution);let m=l[l.length-1].id;for(let u of l)if(u.resolution>o){m=u.id;break}let d=`/media/fetch_media_instance?instance_ID=${m}`;return B(n,d),d}var i={id:void 0,author_id:void 0,last_changed:void 0,content:[]},g={paragraph:document.getElementById("article-paragraph-template"),image:document.getElementById("article-image-template"),heading:document.getElementById("article-heading-template")},E=document.getElementById("editor-container");function N(e){let t=window.open("/gallery-popup","popupWindow","width=600,height=400");window.receive_data=function(n){if(!i.content)return;let r=i.content[e];r.type==1&&(r.src_id=n,_())}}function j(e){let t=document.createElement("input");t.type="file",t.accept="png, jpg, jpeg",t.multiple=!1,t.onchange=async()=>{if(!i.content)return;let n=i.content[e];if(n.type!=1)return;let r=t.files;if(!r)return;let o=Array.from(r)[0];t.remove();let l=new FormData;l.append("media",o);let d=(await A("/media/upload_media",l)).data.results[0].key;n.src_id=d,i.last_changed=s(),_()},t.click()}function z(e,t){let n=e.querySelector(".image-display");if(!n)throw new Error("media-display not found");if(!i.content)throw new Error("article content not initialized");let r=i.content[t];if(r.type!=1)throw new Error("item type is not image");if(!r.src_id){n.classList.toggle("hidden",!0);return}(async()=>{if(!i.content)throw new Error("article content not initialized");let o=i.content[t];if(o.type!=1)throw new Error("item type is not image");if(!o.src_id)throw new Error("src_id not found");n.src=await C(o.src_id,e.clientWidth),n.classList.toggle("hidden",!1)})()}function h(e){if(console.log(e),!E)throw new Error("Editor has not been initalized");let t=document.createElement("li"),n=e.cloneNode(!0);if(!n)throw new Error("could not clone template");let r=n.content;return t.appendChild(r),E.appendChild(t),t}function U(e,t){let n=e.querySelector(".paragraph-input");if(!n)throw new Error("Could not find textarea");let r=i.content[t];if(r.type!=0)throw new Error("Article item at index is not a paragraph");n.value=r.text,n.onchange=()=>{r.text=n.value}}function J(e,t){let n=e.querySelector(".image-alt-text-input");if(!n)throw new Error("could not find alt_text element");let r=i.content[t];if(r.type!=1)throw new Error("Article item at index is not a image");r.alt_text&&(n.value=r.alt_text),n.onchange=()=>{r.alt_text=n.value};let a=e.querySelector(".image-gallery-select"),o=e.querySelector(".image-gallery-upload");a&&(a.onclick=()=>N(t)),o&&(o.onclick=()=>j(t))}function R(e,t){let n=e.querySelector(".delete-button");n&&(n.onclick=()=>{K(t),_()});let r=e.querySelector(".move-up-button");r&&(r.onclick=()=>{P(t),_()});let a=e.querySelector(".move-down-button");a&&(a.onclick=()=>{Y(t),_()})}function _(){let e=window.scrollY;if(!E)throw new Error("Editor is not initialized");if(!i)throw new Error("Article is not initialized");E.innerHTML="";let t;for(let n=0;n<i.content.length;n++){switch(i.content[n].type){case 0:if(!g.paragraph)throw new Error("paragraph template not initialized");t=h(g.paragraph),U(t,n);break;case 1:if(!g.image)throw new Error("image template not initialized");console.log("inserting image"),t=h(g.image),z(t,n),J(t,n);break;case 2:if(!g.heading)throw new Error("image template not initialized");t=h(g.heading);break;default:console.log("Item type in editor-render is unknown, skipping");continue}R(t,n)}requestAnimationFrame(()=>{window.scrollTo(0,e)})}function y(e){i.content||(i.content=[]);let t=i.content.length,n;switch(e){case 0:case 2:n={type:e,text:"",index:t};break;case 1:n={type:e,alt_text:"",index:t,src_id:void 0};break}i.content.push(n),i.last_changed=s(),_()}function K(e){i.content?.splice(e,1),i.last_changed=s()}function Y(e){if(!i.content||e>=i.content.length-1)return;let t=i.content[e];i.content[e]=i.content[e+1],i.content[e+1]=t,i.content[e].index=e,i.content[e+1].index=e+1,i.last_changed=s()}function P(e){if(!i.content||e<1)return;let t=i.content[e];i.content[e]=i.content[e-1],i.content[e-1]=t,i.content[e].index=e,i.content[e-1].index=e-1,i.last_changed=s()}function F(){console.log(i.content)}function T(){let e=document.getElementById("log-article");e&&(e.onclick=()=>F());let t=document.getElementById("add-paragraph");t&&(t.onclick=()=>y(0));let n=document.getElementById("add-image");n&&(n.onclick=()=>y(1));let r=document.getElementById("add-heading");r&&(r.onclick=()=>y(2))}var M="userts-local-user-token",H="userts-local-user-data";function k(){let e=localStorage.getItem(M),t=localStorage.getItem(H);if(!e||!t)return null;let n=JSON.parse(e),r=JSON.parse(t);return!n||!r?null:{token:n,user:r}}function b(){localStorage.removeItem(H),localStorage.removeItem(M)}function L(e){let t=JSON.stringify(e.token),n=JSON.stringify(e.user);return localStorage.setItem(M,t),localStorage.setItem(H,n),!0}function W(){let e=document.querySelector(".user-details-login-template"),t=document.querySelector(".user-details-profile-template"),n=document.querySelector(".user-details-container");return!e||!t||!n?null:{login_template:e,profile_template:t,details_container:n}}function v(){let e=document.querySelector("#user-register-first-name-input"),t=document.querySelector("#user-register-last-name-input"),n=document.querySelector("#user-register-email-input"),r=document.querySelector("#user-register-password-input"),a=document.querySelector("#user-register-password-repeat-input"),o=document.querySelector("#user-register-submitt-button"),l=document.querySelector("#user-signin-email-input"),m=document.querySelector("#user-signin-password-input"),d=document.querySelector("#user-signin-submitt-button");return!e||!t||!n||!r||!a||!o||!l||!m||!d?null:{registration:{email:n,first_name:e,last_name:t,password:r,repeat_password:a,submit:o},signin:{email:l,password:m,submit:d}}}function $(){let e=k();if(!e)throw new Error("No local user-data");p("/user/logout",{user_token:e.token.id}),b(),w()}function G(){let e=W();if(!e)throw new Error("could not load html elements");e.details_container.innerHTML="";let t=k();if(!t){let m=e.login_template.cloneNode(!0);e.details_container.appendChild(m.content);return}let r=e.profile_template.cloneNode(!0).content,a=r.querySelector("#user-profile-first-name");if(!a)throw new Error("fistname_element not found");a.innerHTML=t.user.first_name;let o=r.querySelector("#user-profile-last-name");if(!o)throw new Error("lastname_element not found");o.innerHTML=t.user.last_name;let l=r.querySelector("#user-profile-logout-button");if(!l)throw new Error("logout_button not found");l.onclick=()=>{$()},e.details_container.appendChild(r)}function Q(e,t){let n=v();if(!n)throw new Error("input fields not initialized");if(!e){n.registration.submit.innerHTML=t??"invalid registration-data",n.registration.submit.classList.toggle("bg-green-600",!1),n.registration.submit.classList.toggle("bg-gray-600",!0);return}n.registration.submit.innerHTML="Register",n.registration.submit.classList.toggle("bg-gray-600",!1),n.registration.submit.classList.toggle("bg-green-600",!0)}function I(e){let t=!0,n="";return e.registration.password.value!=e.registration.repeat_password.value&&(t=!1,n="passwords dont match"),e.registration.first_name.value||(t=!1,n="missing first name"),e.registration.email.value||(t=!1,n="missing email"),e.registration.last_name.value||(t=!1,n="missing last name"),e.registration.password.value||(t=!1,n="missing password"),{valid:t,reason:n}}function V(e){if(!I(e).valid)throw new Error("inputs are not valid");(async()=>{let n=v();if(!n)throw new Error("input fields not initialized");if(!I(n).valid)throw new Error("inputs are not valid");let r={email:n.registration.email.value,password:n.registration.password.value,firstname:n.registration.first_name.value,lastname:n.registration.last_name.value},a=await p("/user/register_new_user",r);if(a.error)throw new Error(a.error);let o={email:r.email,password:r.password},l=await p("/user/login",o);if(l.error)throw new Error(l.error);L({user:a,token:l}),window.location.href="/"})()}function f(e){let{valid:t,reason:n}=I(e);Q(t,n)}function X(){let e=v();if(!e)throw new Error("inputs not initialized");e.registration.email.oninput=()=>f(e),e.registration.first_name.oninput=()=>f(e),e.registration.last_name.oninput=()=>f(e),e.registration.password.oninput=()=>f(e),e.registration.repeat_password.oninput=()=>f(e),e.registration.submit.onclick=()=>V(e),f(e)}async function Z(){let e=k();if(!e)return null;if(s()>e.token.expires_at){b(),w();return}if(s()+600>e.token.expires_at){let n=await p("/user/refresh_token",{user_token:e.token.id});if(n.error)throw new Error(n.error);e.token=n,L(e)}let t=await p("/user/who",{user_token:e.token.id});if(t.error)if(t.error==="token invalid"){b(),w();return}else throw new Error(t.error);e.user=t,L(e)}function w(){Z(),G(),window.location.pathname==="/signin"&&X()}window.addEventListener("load",e=>{window.location.pathname==="/editor"&&T(),w()});})();
//# sourceMappingURL=bundle.js.map
