"use strict";(()=>{var l=[],E="C_CACHE_KEY";function w(){localStorage.setItem(E,JSON.stringify(l))}function T(){let e=localStorage.getItem(E);if(!e)return;let t=JSON.parse(e);t&&(l=t)}function L(e){T();for(let t=0;t<l.length;t++)l[t].expires_at<d()&&l.splice(t,1);w();for(let t=0;t<l.length;t++)if(l[t].key==e)return l[t].item;return null}function M(e,t){T();let n={key:e,item:t,expires_at:d()+3600};l.push(n),console.log(n),w()}function d(){return new Date().getTime()/1e3}async function H(e,t){return await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}async function b(e,t){console.log("called stuff");let n=await fetch(e,{method:"POST",body:t});console.log(n);let r=await n.json();return console.log(r),r}async function I(e,t){console.log("getting smallest item from res");let n=`util_get_media_src_by_width${e}${t}`,r=L(n);if(r)return console.log("cache hit"),r;let o=await H("/media/fetch_media",{media_ID:e}),a=Math.pow(t,2),m=await Promise.all(o.instances.map(c=>({id:c.instance_id,resolution:c.x_dimension*c.y_dimension})));m=m.sort((c,k)=>c.resolution-k.resolution);let f=m[m.length-1].id;for(let c of m)if(c.resolution>a){f=c.id;break}let p=`/media/fetch_media_instance?instance_ID=${f}`;return M(n,p),p}var i={id:void 0,author_id:void 0,last_changed:void 0,content:[]},s={paragraph:document.getElementById("article-paragraph-template"),image:document.getElementById("article-image-template"),heading:document.getElementById("article-heading-template")},g=document.getElementById("editor-container");function v(e){let t=window.open("/gallery-popup","popupWindow","width=600,height=400");window.receive_data=function(n){if(!i.content)return;let r=i.content[e];r.type==1&&(r.src_id=n,u())}}function x(e){let t=document.createElement("input");t.type="file",t.accept="png, jpg, jpeg",t.multiple=!1,t.onchange=async()=>{if(!i.content)return;let n=i.content[e];if(n.type!=1)return;let r=t.files;if(!r)return;let a=Array.from(r)[0];t.remove();let m=new FormData;m.append("media",a);let p=(await b("/media/upload_media",m)).data.results[0].key;n.src_id=p,i.last_changed=d(),u()},t.click()}function S(e,t){let n=e.querySelector(".image-display");if(!n)throw new Error("media-display not found");if(!i.content)throw new Error("article content not initialized");let r=i.content[t];if(r.type!=1)throw new Error("item type is not image");if(!r.src_id){n.classList.toggle("hidden",!0);return}(async()=>{if(!i.content)throw new Error("article content not initialized");let a=i.content[t];if(a.type!=1)throw new Error("item type is not image");if(!a.src_id)throw new Error("src_id not found");n.src=await I(a.src_id,e.clientWidth),n.classList.toggle("hidden",!1)})()}function _(e){if(console.log(e),!g)throw new Error("Editor has not been initalized");let t=document.createElement("li"),r=e.cloneNode(!0).content;return t.appendChild(r),g.appendChild(t),t}function A(e,t){let n=e.querySelector(".paragraph-input"),r=i.content[t];if(r.type!=0)throw new Error("Article item at index is not a paragraph");n.value=r.text,n.onchange=()=>{r.text=n.value}}function C(e,t){let n=e.querySelector(".image-alt-text-input"),r=i.content[t];if(r.type!=1)throw new Error("Article item at index is not a image");r.alt_text&&(n.value=r.alt_text),n.onchange=()=>{r.alt_text=n.value};let o=e.querySelector(".image-gallery-select"),a=e.querySelector(".image-gallery-upload");o&&(o.onclick=()=>v(t)),a&&(a.onclick=()=>x(t))}function j(e,t){let n=e.querySelector(".delete-button");n&&(n.onclick=()=>{q(t),u()});let r=e.querySelector(".move-up-button");r&&(r.onclick=()=>{B(t),u()});let o=e.querySelector(".move-down-button");o&&(o.onclick=()=>{z(t),u()})}function u(){let e=window.scrollY;if(!g)throw new Error("Editor is not initialized");if(!i)throw new Error("Article is not initialized");g.innerHTML="";let t;for(let n=0;n<i.content.length;n++){switch(i.content[n].type){case 0:if(!s.paragraph)throw new Error("paragraph template not initialized");t=_(s.paragraph),A(t,n);break;case 1:if(!s.image)throw new Error("image template not initialized");console.log("inserting image"),t=_(s.image),S(t,n),C(t,n);break;case 2:if(!s.heading)throw new Error("image template not initialized");t=_(s.heading);break;default:console.log("Item type in editor-render is unknown, skipping");continue}j(t,n)}requestAnimationFrame(()=>{window.scrollTo(0,e)})}function h(e){i.content||(i.content=[]);let t=i.content.length,n;switch(e){case 0:case 2:n={type:e,text:"",index:t};break;case 1:n={type:e,alt_text:"",index:t,src_id:void 0};break}i.content.push(n),i.last_changed=d(),u()}function q(e){i.content?.splice(e,1),i.last_changed=d()}function z(e){if(!i.content||e>=i.content.length-1)return;let t=i.content[e];i.content[e]=i.content[e+1],i.content[e+1]=t,i.content[e].index=e,i.content[e+1].index=e+1,i.last_changed=d()}function B(e){if(!i.content||e<1)return;let t=i.content[e];i.content[e]=i.content[e-1],i.content[e-1]=t,i.content[e].index=e,i.content[e-1].index=e-1,i.last_changed=d()}function O(){console.log(i.content)}function y(){let e=document.getElementById("log-article");e&&(e.onclick=()=>O());let t=document.getElementById("add-paragraph");t&&(t.onclick=()=>h(0));let n=document.getElementById("add-image");n&&(n.onclick=()=>h(1));let r=document.getElementById("add-heading");r&&(r.onclick=()=>h(2))}window.addEventListener("load",e=>{window.location.pathname==="/editor"&&y()});})();
//# sourceMappingURL=bundle.js.map
