"use strict";(()=>{var ue=Object.create;var O=Object.defineProperty;var me=Object.getOwnPropertyDescriptor;var de=Object.getOwnPropertyNames;var ce=Object.getPrototypeOf,_e=Object.prototype.hasOwnProperty;var pe=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var fe=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of de(t))!_e.call(e,a)&&a!==r&&O(e,a,{get:()=>t[a],enumerable:!(n=me(t,a))||n.enumerable});return e};var E=(e,t,r)=>(r=e!=null?ue(ce(e)):{},fe(t||!e||!e.__esModule?O(r,"default",{value:e,enumerable:!0}):r,e));var f=pe(()=>{"use strict"});var T=E(f());function ge(){let e=document.getElementById("gallery-image-preview-template"),t=document.getElementById("gallery-image-display");return!t||!e?null:{image_preview_template:e,image_display:t}}async function we(){let e=await(void 0)("/media/fetch_all_media_metadata",{});if(e.error)throw new Error(e.error);let t=e;return t.length>1&&t.sort((r,n)=>n.creation_time-r.creation_time),t=t.filter(r=>r&&r.id),t}async function L(){let e=ge();if(!e)throw new Error("Gallery HTML elements not initialized");let r=(await we()).map(async i=>({target:await(void 0)(i.id,e.image_display.clientWidth),media:i})),a=(await Promise.all(r)).map(i=>{let o=document.createElement("li"),m=e.image_preview_template.cloneNode(!0).content;o.appendChild(m);let u=o.querySelector("img");if(!u)throw new Error("could not find image element, something went wrong");return u.src=i.target,{entry:o,...i}}),l=await Promise.all(a);l.forEach(i=>{i.entry.onclick=()=>{window.opener.receive_data(i.media.id),window.close()}}),e.image_display.innerHTML="",l.forEach(i=>{e.image_display.appendChild(i.entry)})}var d=E(f());function Ee(){let e=document.getElementById("image-upload-source"),t=document.getElementById("gallery-image-preview-template"),r=document.getElementById("gallery-image-display"),n=document.getElementById("upload-image-button");return!e||!t||!r||!n?null:{input_source:e,image_preview_template:t,image_display:r,upload_button:n}}async function Te(e){let t=await(void 0)("/media/fetch_all_media_metadata",{});if(console.log(t),t.error)throw new Error(t.error);if(t.success==0)return null;let r=t;if(console.log(r),r.length<=0)throw new Error("no media found");r=r.filter(l=>l&&l.id);let n=r.map(async l=>{let i=await(void 0)(l.id,e.image_display.clientWidth);return{media:l,target_url:i}}),a=await Promise.all(n);return a.length>1&&a.sort((l,i)=>i.media.creation_time-l.media.creation_time),a}async function he(e){let t=e.files;if(!t)throw new Error("no files attached to input source");let r=new FormData;for(let n=0;n<=t.length;n++)r.append("media",t[n]);await(void 0)("/media/upload_media",r),g(),e.value=""}async function ye(e){let t=await Te(e);if(!t){e.image_display.innerHTML="";return}let r=t.map(a=>{let l=document.createElement("li"),o=e.image_preview_template.cloneNode(!0).content;l.append(o);let s=l.querySelector("img");if(!s)throw new Error("could not find img element");return s.src=a.target_url,{entry:l,media:a}}),n=await Promise.all(r);n.forEach(a=>{let l=a.entry.querySelector(".remove-image-button");if(!l)throw new Error("could not find remove media button");l.onclick=async()=>{await(void 0)("/media/update_media_metadata",{media_ID:a.media.media.id,is_unlisted:!0}),g()}}),e.image_display.innerHTML="",n.forEach(a=>e.image_display.appendChild(a.entry))}function g(){let e=Ee();if(!e)throw new Error("html_elements not loaded");e.upload_button.onclick=()=>he(e.input_source),ye(e)}var J=E(f()),P=document.querySelector("#list-article-template"),M=document.querySelector("#list-article-display");function H(){G()}function Le(e){if(!M)throw new Error("Display list_article not found");if(!P)throw new Error("Template is not found");M.innerHTML="";for(let t=0;t<e.length;t++){let n=P.cloneNode(!0).content,a=n.querySelector(".list-article-title");if(!a)throw new Error("title not found");if(a.innerHTML=e[t].title,e[t].image.src_id){let s=n.querySelector(".list-article-image"),m=e[t].image.src_id;s&&(s.src=m)}let l=n.querySelector(".list-article-desc");if(!l)throw new Error("title not found");l.innerHTML=e[t].desc;let i=n.querySelector(".list-article-user_id");if(!i)throw new Error("title not found");i.innerHTML=e[t].user_id;let o=n.querySelector(".list-article-link");if(!o)throw new Error("entry element not found");o.onclick=()=>{window.location.href=`/view?article-id=${e[t].id}`},M.appendChild(n)}}async function G(){let e=await(void 0)("/article/list_all_articles",{});if("error"in e)throw new Error(e.error);Le(e),window.setTimeout(()=>{G()},1e3*60*10)}var V=E(f()),c=document.querySelector("#article-display"),$=document.querySelector("#article-image"),F=document.querySelector("#article-title"),K=document.querySelector("#article-metadata"),Y=document.querySelector("#article-desc"),z=document.querySelector("#article-text");function b(){let t=new URLSearchParams(window.location.search).get("article-id");if(t==null)throw new Error("Article not found!");He(t)}function Me(e){if(!c)throw new Error("Display_article not found");if(!$)throw new Error("Template IMAGE is not found");if(!F)throw new Error("Template TITLE is not found");if(!K)throw new Error("Template METADATA is not found");if(!Y)throw new Error("Template DESC is not found");if(!z)throw new Error("Template TEXT is not found");c.innerHTML="";let t=F.cloneNode(!0),r=t.content,n=r.querySelector(".article-title");if(!n)throw new Error("title not found");n.innerHTML=e.title,c.append(r),t=Y.cloneNode(!0),r=t.content;let a=r.querySelector(".article-desc");if(!a)throw new Error("description not found!");a.innerHTML=e.desc,c.append(r),t=K.cloneNode(!0),r=t.content;let l=r.querySelector(".article-timestamp");if(!l)throw new Error("created timestamp not found");let i=new Date(0);i.setUTCSeconds(e.timestamp),l.innerHTML=`Skrevet: ${i.toLocaleString()}`;let o=r.querySelector(".article-update-timestamp");if(!o)throw new Error("update timestamp not found");let s=new Date(0);s.setUTCSeconds(e.update_timestamp),o.innerHTML=`Oppdatert: ${s.toLocaleString()}`;let m=r.querySelector(".article-author");if(!m)throw new Error("author not found");m.innerHTML=`Skrevet av ${e.user_id}`,c.append(r);for(let u=0;u<e.body.length;u++)switch(e.body[u].type){case"image":t=$.cloneNode(!0),r=t.content;let j=r.querySelector(".article-image"),se=e.body[u].src_id;j&&(j.src=se),c.appendChild(r);break;case"paragraph":t=z.cloneNode(!0),r=t.content;let B=r.querySelector(".article-text");if(!B)throw new Error("text not found");B.innerHTML=e.body[u].text,c.appendChild(r);break}}async function He(e){let t=await(void 0)("/article/get_article",{id:e});if("error"in t)throw new Error(t.error);console.log(t),Me(t)}async function _(e,t){let r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=r.status,a=await r.json();return{time:a.time,message:a.message,data:a.data,success:a.success,status_code:n}}async function W(e,t){let n=await _("/user/login",{email:e,password:t});if(n.success==0)return{response:n};let a=n.data;return{response:n,token:a}}async function X(e){return{response:await _("/user/login",{auth_token:e})}}async function Q(e,t,r,n){let l=await _("user/register",{email:e,password:t,firstname:r,lastname:n});if(l.success==0)return{response:l};let i=l.data;return{response:l,userdata:i}}async function Z(e){let r=await _("/user/who",{auth_token:e});if(console.log(r),r.success==0)throw new Error(r.message);let n=r.data;return console.log(n),{response:r,userdata:n}}async function ee(){let e=await _("/user/admin_test_creds",{});if(e.success==0)throw new Error(e.message);let t=e.data;return{response:e,admin:t}}var v="BCMS_USERTS_LOCALTOKEN",x="BCMS_USERTS_LOCALUSER";function w(){let e=localStorage.getItem(v),t=localStorage.getItem(x);if(!e||!t)return null;let r=JSON.parse(e),n=JSON.parse(t);return!r||!n?null:{token:r,user:n}}function te(){return localStorage.removeItem(x),localStorage.removeItem(v),!0}function I(e){let t=JSON.stringify(e.token),r=JSON.stringify(e.user);return localStorage.setItem(v,t),localStorage.setItem(x,r),!0}async function re(){let e=await ee();if(console.log(e),!e.admin)throw new Error(e.response.message);let t=await Z(e.admin.id);if(console.log(t),!t.userdata)throw new Error(t.response.message);let r={token:e.admin,user:t.userdata};return I(r),r}function Se(){let e=document.querySelector(".user-details-login-template"),t=document.querySelector(".user-details-profile-template"),r=document.querySelector(".user-details-container");return!e||!t||!r?null:{login_template:e,profile_template:t,details_container:r}}function ve(){let e=w();if(!e)throw new Error("No local user-data");X(e.token.id),te(),D()}function xe(){let e=Se();if(!e)throw new Error("could not load html elements");e.details_container.innerHTML="";let t=w();if(!t){let o=e.login_template.cloneNode(!0);e.details_container.appendChild(o.content);return}let n=e.profile_template.cloneNode(!0).content,a=n.querySelector("#user-profile-first-name");if(!a)throw new Error("fistname_element not found");a.innerHTML=t.user.firstname;let l=n.querySelector("#user-profile-last-name");if(!l)throw new Error("lastname_element not found");l.innerHTML=t.user.lastname;let i=n.querySelector("#user-profile-logout-button");if(!i)throw new Error("logout_button not found");i.onclick=()=>{ve()},e.details_container.appendChild(n)}async function D(){await re(),xe()}function A(){let e=document.querySelector("#user-register-first-name-input"),t=document.querySelector("#user-register-last-name-input"),r=document.querySelector("#user-register-email-input"),n=document.querySelector("#user-register-password-input"),a=document.querySelector("#user-register-password-repeat-input"),l=document.querySelector("#user-register-submitt-button"),i=document.querySelector("#user-signin-email-input"),o=document.querySelector("#user-signin-password-input"),s=document.querySelector("#user-signin-submitt-button");return!e||!t||!r||!n||!a||!l||!i||!o||!s?null:{registration:{email:r,first_name:e,last_name:t,password:n,repeat_password:a,submit:l},signin:{email:i,password:o,submit:s}}}function Ie(e,t){let r=A();if(!r)throw new Error("input fields not initialized");if(!e){r.registration.submit.innerHTML=t??"invalid registration-data",r.registration.submit.classList.toggle("bg-green-600",!1),r.registration.submit.classList.toggle("bg-gray-600",!0);return}r.registration.submit.innerHTML="Register",r.registration.submit.classList.toggle("bg-gray-600",!1),r.registration.submit.classList.toggle("bg-green-600",!0)}function k(e){let t=!0,r="";return e.registration.password.value!=e.registration.repeat_password.value&&(t=!1,r="passwords dont match"),e.registration.first_name.value||(t=!1,r="missing first name"),e.registration.email.value||(t=!1,r="missing email"),e.registration.last_name.value||(t=!1,r="missing last name"),e.registration.password.value||(t=!1,r="missing password"),{valid:t,reason:r}}function De(e){if(!k(e).valid)throw new Error("inputs are not valid");(async()=>{let r=A();if(!r)throw new Error("input fields not initialized");if(!k(r).valid)throw new Error("inputs are not valid");let n=await Q(r.registration.email.value,r.registration.password.value,r.registration.first_name.value,r.registration.last_name.value);if(!n.userdata)throw new Error(n.response.message);let a=await W(r.registration.email.value,r.registration.password.value);if(!a.token)throw new Error(a.response.message);let l={token:a.token,user:n.userdata};I(l),window.location.href="/"})()}function p(e){let{valid:t,reason:r}=k(e);Ie(t,r)}function ae(){let e=A();if(!e)throw new Error("inputs not initialized");e.registration.email.oninput=()=>p(e),e.registration.first_name.oninput=()=>p(e),e.registration.last_name.oninput=()=>p(e),e.registration.password.oninput=()=>p(e),e.registration.repeat_password.oninput=()=>p(e),e.registration.submit.onclick=()=>De(e),p(e)}function h(){return window.crypto.randomUUID()}function q(){return new Date().getTime()/1e3}var le="BCMS_EDITORTS_LOCAL_DRAFTS";function ie(){let e=localStorage.getItem(le);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("could not parse the local drafts, you fucked up somehow");return t}function C(e){let t=JSON.stringify(e);localStorage.setItem(le,t)}function oe(e){return{author_id:e.id,content:[],description:"This is a draft article",last_changed:q(),draft_id:h(),title:"New article"}}var N=class{constructor(){this.listeners=[];this.on=(t,r)=>{let n={event_type:t,callback:r,listener_id:h()};return this.listeners.push(n),n};this.clear=t=>{for(let r=0;r<this.listeners.length;r++)if(this.listeners[r].listener_id==t){this.listeners.splice(r,1);break}};this.emit=(t,r)=>{this.listeners.forEach(n=>{n.event_type==t&&n.callback(r)})}}},y=new N;function Ue(e){let t=e.querySelector(".delete-draft-button"),r=e.querySelector(".edit-draft-button"),n=e.querySelector(".draft-render-title"),a=e.querySelector(".draft-render-description");return!t||!r||!n||!a?null:{delete_draft_button:t,edit_draft_button:r,draft_render_title:n,draft_render_description:a}}function Ce(){let e=document.getElementById("draft-preview-template"),t=document.getElementById("editor-app-view"),r=document.getElementById("draft-controlls-template");if(!e||!t||!r)return null;let a=r.cloneNode(!0).content,l=a.querySelector(".draft-controlls"),i=a.querySelector(".new-draft-button"),o=a.querySelector(".draft-render-list");return!l||!i||!o?(console.log("controlls not found"),null):(t.innerHTML="",t.appendChild(a),{draft_preview_template:e,editor_app_view:t,draft_controlls_template:r,draft_controlls:l,new_draft_button:i,draft_render_list:o})}function Ne(e,t){e.draft_render_list.innerHTML="";for(let r=0;r<t.length;r++){let a=e.draft_preview_template.cloneNode(!0).content,l=Ue(a);if(!l)throw new Error("could not instantiate draft template elements");l.draft_render_title.innerText=t[r].title,l.draft_render_description.innerText=t[r].description,e.draft_render_list.appendChild(a)}}function R(){let e=w();if(!e)throw new Error("User not logged in");let t=Ce();if(!t)throw new Error("Draft items not found, cant render page");y.on(2,n=>{Ne(t,n)});let r=ie();r||(r=[],C(r)),y.emit(2,r),t.new_draft_button.onclick=()=>{let n=oe(e.user);r.push(n),C(r),y.emit(2,r)},console.log("editor draft view")}window.addEventListener("load",e=>{switch(D(),window.location.pathname){case"/editor":if(new URLSearchParams(window.location.search).get("draft-id")==null){console.log("no draft chosen"),R();break}break;case"/gallery-popup":L();break;case"/gallery":g();break;case"/view":b();break;case"/signin":ae();break;case"/":H();break;default:break}});})();
//# sourceMappingURL=bundle.js.map
