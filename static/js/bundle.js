"use strict";(()=>{var O="utilts-cache-stroage-key";function P(e){localStorage.setItem(O,JSON.stringify(e))}function J(){let e=localStorage.getItem(O);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("cache cant be parsed");return t}function oe(e){let t=J();if(!t)return null;for(let r=0;r<t.length;r++)t[r].expires_at<_()&&t.splice(r,1);P(t);for(let r=0;r<t.length;r++)if(t[r].key==e)return t[r].item;return null}function se(e,t,r=3600){let n=J();n||(n=[]);let a={key:e,item:t,expires_at:_()+r};n.push(a),console.log(a),P(n)}function _(){return new Date().getTime()/1e3}async function d(e,t){let r=p();return r&&(t.auth_token=r.token.id),await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}async function L(e,t){let r=p();r&&t.append("auth_token",r?.token.id);let n=await fetch(e,{method:"POST",body:t});console.log(n);let a=await n.json();return console.log(a),a}async function E(e,t){console.log("getting smallest item from res");let r=`util_get_media_src_by_width-${e}-${t}`,n=oe(r);if(n)return n;let a=await d("/media/fetch_media",{media_ID:e}),l=Math.pow(t,2),i=await Promise.all(a.instances.map(u=>({id:u.instance_id,resolution:u.x_dimension*u.y_dimension})));i=i.sort((u,m)=>u.resolution-m.resolution);let o=i[i.length-1].id;for(let u of i)if(u.resolution>l){o=u.id;break}let s=`/media/fetch_media_instance?instance_ID=${o}`;return se(r,s),s}async function y(e,t){let r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=r.status,a=await r.json();return{time:a.time,message:a.message,data:a.data,success:a.success,status_code:n}}async function G(e,t){let n=await y("/user/login",{email:e,password:t});if(n.success==0)return{response:n};let a=n.data;return{response:n,token:a}}async function Y(e){return{response:await y("/user/login",{auth_token:e})}}async function $(e,t,r,n){let l=await y("user/register",{email:e,password:t,firstname:r,lastname:n});if(l.success==0)return{response:l};let i=l.data;return{response:l,userdata:i}}async function z(e){let r=await y("/user/who",{auth_token:e});if(console.log(r),r.success==0)throw new Error(r.message);let n=r.data;return console.log(n),{response:r,userdata:n}}async function K(){let e=await y("/user/admin_test_creds",{});if(e.success==0)throw new Error(e.message);let t=e.data;return{response:e,admin:t}}var H="BCMS_USERTS_LOCALTOKEN",S="BCMS_USERTS_LOCALUSER";function p(){let e=localStorage.getItem(H),t=localStorage.getItem(S);if(!e||!t)return null;let r=JSON.parse(e),n=JSON.parse(t);return!r||!n?null:{token:r,user:n}}function W(){return localStorage.removeItem(S),localStorage.removeItem(H),!0}function I(e){let t=JSON.stringify(e.token),r=JSON.stringify(e.user);return localStorage.setItem(H,t),localStorage.setItem(S,r),!0}async function F(){let e=await K();if(console.log(e),!e.admin)throw new Error(e.response.message);let t=await z(e.admin.id);if(console.log(t),!t.userdata)throw new Error(t.response.message);let r={token:e.admin,user:t.userdata};return I(r),r}var Q="editor-ts-local-article";function c(){let e=localStorage.getItem(Q);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("could not parse the local article, you fucked up somehow");return t}function g(e){let t=JSON.stringify(e);localStorage.setItem(Q,t)}function ce(){let e=p();if(!e)throw new Error("no user data found, not logged in");let t={author_id:e.user.id,content:[],description:"",last_changed:_(),id:void 0,title:""};return g(t),t}function me(){let e=document.getElementById("log-article"),t=document.getElementById("add-paragraph"),r=document.getElementById("add-image"),n=document.getElementById("add-heading");return!e||!t||!r||!n?null:{log_button:e,add_paragraph_button:t,add_image_button:r,add_heading_button:n}}function de(){let e=document.getElementById("article-paragraph-template"),t=document.getElementById("article-image-template"),r=document.getElementById("article-heading-template");return!e||!t||!r?null:{paragraph:e,image:t,heading:r}}function _e(){return document.getElementById("editor-container")}function pe(e){let t=window.open("/gallery-popup","popupWindow","width=600,height=400");window.receive_data=function(r){console.log(r);let n=c();if(!n)throw new Error("could not load artilce");let a=n.content[e];a.type==ArticleItemTypeEnum.image&&(a.src_id=r,g(n),f())}}function ge(e){let t=document.createElement("input");t.type="file",t.accept="png, jpg, jpeg",t.multiple=!1,t.onchange=async()=>{let r=c();if(!r)throw new Error("could not load artilce");let n=r.content[e];if(n.type!=ArticleItemTypeEnum.image)return;let a=t.files;if(!a)return;let i=Array.from(a)[0];t.remove();let o=new FormData;o.append("media",i);let u=(await L("/media/upload_media",o)).data.results[0].key;n.src_id=u,r.last_changed=_(),g(r),f()},t.click()}function fe(e,t,r){let n=e.querySelector(".image-display");if(!n)throw new Error("media-display not found");let a=r.content[t];if(a.type!=ArticleItemTypeEnum.image)throw new Error("item type is not image");if(!a.src_id){n.classList.toggle("hidden",!0);return}(async()=>{let i=r.content[t];if(i.type!=ArticleItemTypeEnum.image)throw new Error("item type is not image");if(!i.src_id)throw new Error("src_id not found");n.src=await E(i.src_id,e.clientWidth),n.classList.toggle("hidden",!1)})()}function k(e,t){console.log(e);let r=document.createElement("li"),n=e.cloneNode(!0);if(!n)throw new Error("could not clone template");let a=n.content;return r.appendChild(a),t.appendChild(r),r}function we(e,t){let r=c();if(!r)throw new Error("could not load article");let n=e.querySelector(".paragraph-input");if(!n)throw new Error("Could not find textarea");let a=r.content[t];if(a.type!=ArticleItemTypeEnum.paragraph)throw new Error("Article item at index is not a paragraph");n.value=a.text,n.onchange=()=>{let l=c();if(!l)throw new Error("could not load article");let i=l.content[t];if(i.type!=ArticleItemTypeEnum.paragraph)throw new Error("Article item at index is not a paragraph");i.text=n.value,g(l)}}function Ee(e,t){let r=c();if(!r)throw new Error("could not load article");let n=r.content[t];if(n.type!=ArticleItemTypeEnum.image)throw new Error("Article item at index is not a image");let a=e.querySelector(".image-alt-text-input");if(!a)throw new Error("could not find alt_text element");a.value=n.alt_text,a.onchange=()=>{let o=c();if(!o)throw new Error("could not load article");let s=o.content[t];if(s.type!=ArticleItemTypeEnum.image)throw new Error("Article item at index is not a image");s.alt_text=a.value,g(o)};let l=e.querySelector(".image-gallery-select"),i=e.querySelector(".image-gallery-upload");l&&(l.onclick=()=>pe(t)),i&&(i.onclick=()=>ge(t))}function he(e,t){let r=e.querySelector(".delete-button");r&&(r.onclick=()=>{ye(t),f()});let n=e.querySelector(".move-up-button");n&&(n.onclick=()=>{X(t,-1),f()});let a=e.querySelector(".move-down-button");a&&(a.onclick=()=>{X(t,1),f()})}function f(){let e=c();if(!e)throw new Error("could not load article");let t=window.scrollY,r=_e(),n=de();if(!r)throw new Error("Editor is not initialized");if(!n)throw new Error("templates did not load");r.innerHTML="";let a;for(let l=0;l<e.content.length;l++){switch(e.content[l].type){case ArticleItemTypeEnum.paragraph:a=k(n.paragraph,r),we(a,l);break;case ArticleItemTypeEnum.image:a=k(n.image,r),fe(a,l,e),Ee(a,l);break;case ArticleItemTypeEnum.heading:a=k(n.heading,r);break;default:console.log("Item type in editor-render is unknown, skipping");continue}he(a,l)}g(e),requestAnimationFrame(()=>{window.scrollTo(0,t)})}function A(e){let t=c();if(!t)throw new Error("could not load artilce");let r=t.content.length,n;switch(e){case ArticleItemTypeEnum.paragraph:case ArticleItemTypeEnum.heading:n={type:e,text:"",index:r};break;case ArticleItemTypeEnum.image:n={type:e,alt_text:"",index:r,src_id:void 0};break}t.content.push(n),t.last_changed=_(),g(t),f()}function ye(e){let t=c();if(!t)throw new Error("could not load article");return t.content.splice(e,1),t.last_changed=_(),g(t),t}function X(e,t){let r=c();if(!r)throw new Error("could not load article");let n=e+t;if(n<0||n>=r.content.length)throw new Error("target position is out of bounds");let[a]=r.content.splice(e,1);return r.content.splice(n,0,a),r.last_changed=_(),g(r),r}function v(){if(!p()){window.location.href="/";return}let t=c();t||(t=ce());let r=me();if(!r)throw new Error("controll buttons not initialized");r.log_button.onclick=()=>console.log(t),r.add_paragraph_button.onclick=()=>A(ArticleItemTypeEnum.paragraph),r.add_image_button.onclick=()=>A(ArticleItemTypeEnum.image),r.add_heading_button.onclick=()=>A(ArticleItemTypeEnum.heading),f()}function Te(){let e=document.getElementById("gallery-image-preview-template"),t=document.getElementById("gallery-image-display");return!t||!e?null:{image_preview_template:e,image_display:t}}async function Le(){let e=await d("/media/fetch_all_media_metadata",{});if(e.error)throw new Error(e.error);let t=e;return t.length>1&&t.sort((r,n)=>n.creation_time-r.creation_time),t=t.filter(r=>r&&r.id),t}async function x(){let e=Te();if(!e)throw new Error("Gallery HTML elements not initialized");let r=(await Le()).map(async i=>({target:await E(i.id,e.image_display.clientWidth),media:i})),a=(await Promise.all(r)).map(i=>{let o=document.createElement("li"),u=e.image_preview_template.cloneNode(!0).content;o.appendChild(u);let m=o.querySelector("img");if(!m)throw new Error("could not find image element, something went wrong");return m.src=i.target,{entry:o,...i}}),l=await Promise.all(a);l.forEach(i=>{i.entry.onclick=()=>{window.opener.receive_data(i.media.id),window.close()}}),e.image_display.innerHTML="",l.forEach(i=>{e.image_display.appendChild(i.entry)})}function be(){let e=document.getElementById("image-upload-source"),t=document.getElementById("gallery-image-preview-template"),r=document.getElementById("gallery-image-display"),n=document.getElementById("upload-image-button");return!e||!t||!r||!n?null:{input_source:e,image_preview_template:t,image_display:r,upload_button:n}}async function Me(e){let t=await d("/media/fetch_all_media_metadata",{});if(console.log(t),t.error)throw new Error(t.error);if(t.success==0)return null;let r=t;if(console.log(r),r.length<=0)throw new Error("no media found");r=r.filter(l=>l&&l.id);let n=r.map(async l=>{let i=await E(l.id,e.image_display.clientWidth);return{media:l,target_url:i}}),a=await Promise.all(n);return a.length>1&&a.sort((l,i)=>i.media.creation_time-l.media.creation_time),a}async function He(e){let t=e.files;if(!t)throw new Error("no files attached to input source");let r=new FormData;for(let n=0;n<=t.length;n++)r.append("media",t[n]);await L("/media/upload_media",r),T(),e.value=""}async function Se(e){let t=await Me(e);if(!t){e.image_display.innerHTML="";return}let r=t.map(a=>{let l=document.createElement("li"),o=e.image_preview_template.cloneNode(!0).content;l.append(o);let s=l.querySelector("img");if(!s)throw new Error("could not find img element");return s.src=a.target_url,{entry:l,media:a}}),n=await Promise.all(r);n.forEach(a=>{let l=a.entry.querySelector(".remove-image-button");if(!l)throw new Error("could not find remove media button");l.onclick=async()=>{await d("/media/update_media_metadata",{media_ID:a.media.media.id,is_unlisted:!0}),T()}}),e.image_display.innerHTML="",n.forEach(a=>e.image_display.appendChild(a.entry))}function T(){let e=be();if(!e)throw new Error("html_elements not loaded");e.upload_button.onclick=()=>He(e.input_source),Se(e)}var V=document.querySelector("#list-article-template"),q=document.querySelector("#list-article-display");function D(){Z()}function Ie(e){if(!q)throw new Error("Display list_article not found");if(!V)throw new Error("Template is not found");q.innerHTML="";for(let t=0;t<e.length;t++){let n=V.cloneNode(!0).content,a=n.querySelector(".list-article-title");if(!a)throw new Error("title not found");if(a.innerHTML=e[t].title,e[t].image.src_id){let s=n.querySelector(".list-article-image"),u=e[t].image.src_id;s&&(s.src=u)}let l=n.querySelector(".list-article-desc");if(!l)throw new Error("title not found");l.innerHTML=e[t].desc;let i=n.querySelector(".list-article-user_id");if(!i)throw new Error("title not found");i.innerHTML=e[t].user_id;let o=n.querySelector(".list-article-link");if(!o)throw new Error("entry element not found");o.onclick=()=>{window.location.href=`/view?article-id=${e[t].id}`},q.appendChild(n)}}async function Z(){let e=await d("/article/list_all_articles",{});if("error"in e)throw new Error(e.error);Ie(e),window.setTimeout(()=>{Z()},1e3*60*10)}var w=document.querySelector("#article-display"),ee=document.querySelector("#article-image"),te=document.querySelector("#article-title"),re=document.querySelector("#article-metadata"),ne=document.querySelector("#article-desc"),ae=document.querySelector("#article-text");function U(){let t=new URLSearchParams(window.location.search).get("article-id");if(t==null)throw new Error("Article not found!");Ae(t)}function ke(e){if(!w)throw new Error("Display_article not found");if(!ee)throw new Error("Template IMAGE is not found");if(!te)throw new Error("Template TITLE is not found");if(!re)throw new Error("Template METADATA is not found");if(!ne)throw new Error("Template DESC is not found");if(!ae)throw new Error("Template TEXT is not found");w.innerHTML="";let t=te.cloneNode(!0),r=t.content,n=r.querySelector(".article-title");if(!n)throw new Error("title not found");n.innerHTML=e.title,w.append(r),t=ne.cloneNode(!0),r=t.content;let a=r.querySelector(".article-desc");if(!a)throw new Error("description not found!");a.innerHTML=e.desc,w.append(r),t=re.cloneNode(!0),r=t.content;let l=r.querySelector(".article-timestamp");if(!l)throw new Error("created timestamp not found");let i=new Date(0);i.setUTCSeconds(e.timestamp),l.innerHTML=`Skrevet: ${i.toLocaleString()}`;let o=r.querySelector(".article-update-timestamp");if(!o)throw new Error("update timestamp not found");let s=new Date(0);s.setUTCSeconds(e.update_timestamp),o.innerHTML=`Oppdatert: ${s.toLocaleString()}`;let u=r.querySelector(".article-author");if(!u)throw new Error("author not found");u.innerHTML=`Skrevet av ${e.user_id}`,w.append(r);for(let m=0;m<e.body.length;m++)switch(e.body[m].type){case"image":t=ee.cloneNode(!0),r=t.content;let N=r.querySelector(".article-image"),ie=e.body[m].src_id;N&&(N.src=ie),w.appendChild(r);break;case"paragraph":t=ae.cloneNode(!0),r=t.content;let j=r.querySelector(".article-text");if(!j)throw new Error("text not found");j.innerHTML=e.body[m].text,w.appendChild(r);break}}async function Ae(e){let t=await d("/article/get_article",{id:e});if("error"in t)throw new Error(t.error);console.log(t),ke(t)}function ve(){let e=document.querySelector(".user-details-login-template"),t=document.querySelector(".user-details-profile-template"),r=document.querySelector(".user-details-container");return!e||!t||!r?null:{login_template:e,profile_template:t,details_container:r}}function xe(){let e=p();if(!e)throw new Error("No local user-data");Y(e.token.id),W(),C()}function qe(){let e=ve();if(!e)throw new Error("could not load html elements");e.details_container.innerHTML="";let t=p();if(!t){let o=e.login_template.cloneNode(!0);e.details_container.appendChild(o.content);return}let n=e.profile_template.cloneNode(!0).content,a=n.querySelector("#user-profile-first-name");if(!a)throw new Error("fistname_element not found");a.innerHTML=t.user.firstname;let l=n.querySelector("#user-profile-last-name");if(!l)throw new Error("lastname_element not found");l.innerHTML=t.user.lastname;let i=n.querySelector("#user-profile-logout-button");if(!i)throw new Error("logout_button not found");i.onclick=()=>{xe()},e.details_container.appendChild(n)}async function C(){await F(),qe()}function B(){let e=document.querySelector("#user-register-first-name-input"),t=document.querySelector("#user-register-last-name-input"),r=document.querySelector("#user-register-email-input"),n=document.querySelector("#user-register-password-input"),a=document.querySelector("#user-register-password-repeat-input"),l=document.querySelector("#user-register-submitt-button"),i=document.querySelector("#user-signin-email-input"),o=document.querySelector("#user-signin-password-input"),s=document.querySelector("#user-signin-submitt-button");return!e||!t||!r||!n||!a||!l||!i||!o||!s?null:{registration:{email:r,first_name:e,last_name:t,password:n,repeat_password:a,submit:l},signin:{email:i,password:o,submit:s}}}function De(e,t){let r=B();if(!r)throw new Error("input fields not initialized");if(!e){r.registration.submit.innerHTML=t??"invalid registration-data",r.registration.submit.classList.toggle("bg-green-600",!1),r.registration.submit.classList.toggle("bg-gray-600",!0);return}r.registration.submit.innerHTML="Register",r.registration.submit.classList.toggle("bg-gray-600",!1),r.registration.submit.classList.toggle("bg-green-600",!0)}function R(e){let t=!0,r="";return e.registration.password.value!=e.registration.repeat_password.value&&(t=!1,r="passwords dont match"),e.registration.first_name.value||(t=!1,r="missing first name"),e.registration.email.value||(t=!1,r="missing email"),e.registration.last_name.value||(t=!1,r="missing last name"),e.registration.password.value||(t=!1,r="missing password"),{valid:t,reason:r}}function Ue(e){if(!R(e).valid)throw new Error("inputs are not valid");(async()=>{let r=B();if(!r)throw new Error("input fields not initialized");if(!R(r).valid)throw new Error("inputs are not valid");let n=await $(r.registration.email.value,r.registration.password.value,r.registration.first_name.value,r.registration.last_name.value);if(!n.userdata)throw new Error(n.response.message);let a=await G(r.registration.email.value,r.registration.password.value);if(!a.token)throw new Error(a.response.message);let l={token:a.token,user:n.userdata};I(l),window.location.href="/"})()}function h(e){let{valid:t,reason:r}=R(e);De(t,r)}function le(){let e=B();if(!e)throw new Error("inputs not initialized");e.registration.email.oninput=()=>h(e),e.registration.first_name.oninput=()=>h(e),e.registration.last_name.oninput=()=>h(e),e.registration.password.oninput=()=>h(e),e.registration.repeat_password.oninput=()=>h(e),e.registration.submit.onclick=()=>Ue(e),h(e)}window.addEventListener("load",e=>{switch(C(),window.location.pathname){case"/editor":v();break;case"/gallery-popup":x();break;case"/gallery":T();break;case"/view":U();break;case"/signin":le();break;case"/":D();break;default:break}});})();
//# sourceMappingURL=bundle.js.map
