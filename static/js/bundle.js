"use strict";(()=>{var S="utilts-cache-stroage-key";function v(e){localStorage.setItem(S,JSON.stringify(e))}function x(){let e=localStorage.getItem(S);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("cache cant be parsed");return t}function O(e){let t=x();if(!t)return null;for(let n=0;n<t.length;n++)t[n].expires_at<c()&&t.splice(n,1);v(t);for(let n=0;n<t.length;n++)if(t[n].key==e)return t[n].item;return null}function N(e,t,n=3600){let r=x();r||(r=[]);let i={key:e,item:t,expires_at:c()+n};r.push(i),console.log(i),v(r)}function c(){return new Date().getTime()/1e3}async function d(e,t){let n=p();return n&&(t.auth_token=n.token.id),await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}async function q(e,t){let n=p();n&&t.append("auth_token",n?.token.id);let r=await fetch(e,{method:"POST",body:t});console.log(r);let i=await r.json();return console.log(i),i}async function h(e,t){console.log("getting smallest item from res");let n=`util_get_media_src_by_width-${e}-${t}`,r=O(n);if(r)return r;let i=await d("/media/fetch_media",{media_ID:e}),l=Math.pow(t,2),a=await Promise.all(i.instances.map(s=>({id:s.instance_id,resolution:s.x_dimension*s.y_dimension})));a=a.sort((s,w)=>s.resolution-w.resolution);let o=a[a.length-1].id;for(let s of a)if(s.resolution>l){o=s.id;break}let u=`/media/fetch_media_instance?instance_ID=${o}`;return N(n,u),u}var T="userts-local-user-token",b="userts-local-user-data";function p(){let e=localStorage.getItem(T),t=localStorage.getItem(b);if(!e||!t)return null;let n=JSON.parse(e),r=JSON.parse(t);return!n||!r?null:{token:n,user:r}}function D(){localStorage.removeItem(b),localStorage.removeItem(T)}function B(e){let t=JSON.stringify(e.token),n=JSON.stringify(e.user);return localStorage.setItem(T,t),localStorage.setItem(b,n),!0}function j(){let e=document.querySelector(".user-details-login-template"),t=document.querySelector(".user-details-profile-template"),n=document.querySelector(".user-details-container");return!e||!t||!n?null:{login_template:e,profile_template:t,details_container:n}}function L(){let e=document.querySelector("#user-register-first-name-input"),t=document.querySelector("#user-register-last-name-input"),n=document.querySelector("#user-register-email-input"),r=document.querySelector("#user-register-password-input"),i=document.querySelector("#user-register-password-repeat-input"),l=document.querySelector("#user-register-submitt-button"),a=document.querySelector("#user-signin-email-input"),o=document.querySelector("#user-signin-password-input"),u=document.querySelector("#user-signin-submitt-button");return!e||!t||!n||!r||!i||!l||!a||!o||!u?null:{registration:{email:n,first_name:e,last_name:t,password:r,repeat_password:i,submit:l},signin:{email:a,password:o,submit:u}}}function U(){let e=p();if(!e)throw new Error("No local user-data");d("/user/logout",{user_token:e.token.id}),D(),E()}function J(){let e=j();if(!e)throw new Error("could not load html elements");e.details_container.innerHTML="";let t=p();if(!t){let o=e.login_template.cloneNode(!0);e.details_container.appendChild(o.content);return}let r=e.profile_template.cloneNode(!0).content,i=r.querySelector("#user-profile-first-name");if(!i)throw new Error("fistname_element not found");i.innerHTML=t.user.first_name;let l=r.querySelector("#user-profile-last-name");if(!l)throw new Error("lastname_element not found");l.innerHTML=t.user.last_name;let a=r.querySelector("#user-profile-logout-button");if(!a)throw new Error("logout_button not found");a.onclick=()=>{U()},e.details_container.appendChild(r)}function R(e,t){let n=L();if(!n)throw new Error("input fields not initialized");if(!e){n.registration.submit.innerHTML=t??"invalid registration-data",n.registration.submit.classList.toggle("bg-green-600",!1),n.registration.submit.classList.toggle("bg-gray-600",!0);return}n.registration.submit.innerHTML="Register",n.registration.submit.classList.toggle("bg-gray-600",!1),n.registration.submit.classList.toggle("bg-green-600",!0)}function y(e){let t=!0,n="";return e.registration.password.value!=e.registration.repeat_password.value&&(t=!1,n="passwords dont match"),e.registration.first_name.value||(t=!1,n="missing first name"),e.registration.email.value||(t=!1,n="missing email"),e.registration.last_name.value||(t=!1,n="missing last name"),e.registration.password.value||(t=!1,n="missing password"),{valid:t,reason:n}}function z(e){if(!y(e).valid)throw new Error("inputs are not valid");(async()=>{let n=L();if(!n)throw new Error("input fields not initialized");if(!y(n).valid)throw new Error("inputs are not valid");let r={email:n.registration.email.value,password:n.registration.password.value,firstname:n.registration.first_name.value,lastname:n.registration.last_name.value},i=await d("/user/register_new_user",r);if(i.error)throw new Error(i.error);let l={email:r.email,password:r.password},a=await d("/user/login",l);if(a.error)throw new Error(a.error);B({user:i,token:a}),window.location.href="/"})()}function f(e){let{valid:t,reason:n}=y(e);R(t,n)}function K(){let e=L();if(!e)throw new Error("inputs not initialized");e.registration.email.oninput=()=>f(e),e.registration.first_name.oninput=()=>f(e),e.registration.last_name.oninput=()=>f(e),e.registration.password.oninput=()=>f(e),e.registration.repeat_password.oninput=()=>f(e),e.registration.submit.onclick=()=>z(e),f(e)}async function P(){let e=await d("/user/admin_test_creds",{}),t=await d("/user/who",{user_token:e.id});B({token:e,user:t})}function E(){P(),J(),window.location.pathname==="/signin"&&K()}var C="editor-ts-local-article";function m(){let e=localStorage.getItem(C);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("could not parse the local article, you fucked up somehow");return t}function _(e){let t=JSON.stringify(e);localStorage.setItem(C,t)}function Y(){let e=p();if(!e)throw new Error("no user data found, not logged in");let t={author_id:e.user.id,content:[],description:"",last_changed:c(),id:void 0,title:""};return _(t),t}function G(){let e=document.getElementById("log-article"),t=document.getElementById("add-paragraph"),n=document.getElementById("add-image"),r=document.getElementById("add-heading");return!e||!t||!n||!r?null:{log_button:e,add_paragraph_button:t,add_image_button:n,add_heading_button:r}}function W(){let e=document.getElementById("article-paragraph-template"),t=document.getElementById("article-image-template"),n=document.getElementById("article-heading-template");return!e||!t||!n?null:{paragraph:e,image:t,heading:n}}function F(){return document.getElementById("editor-container")}function $(e){let t=window.open("/gallery-popup","popupWindow","width=600,height=400");window.receive_data=function(n){console.log(n);let r=m();if(!r)throw new Error("could not load artilce");let i=r.content[e];i.type==1&&(i.src_id=n,_(r),g())}}function Q(e){let t=document.createElement("input");t.type="file",t.accept="png, jpg, jpeg",t.multiple=!1,t.onchange=async()=>{let n=m();if(!n)throw new Error("could not load artilce");let r=n.content[e];if(r.type!=1)return;let i=t.files;if(!i)return;let a=Array.from(i)[0];t.remove();let o=new FormData;o.append("media",a);let s=(await q("/media/upload_media",o)).data.results[0].key;r.src_id=s,n.last_changed=c(),_(n),g()},t.click()}function V(e,t,n){let r=e.querySelector(".image-display");if(!r)throw new Error("media-display not found");let i=n.content[t];if(i.type!=1)throw new Error("item type is not image");if(!i.src_id){r.classList.toggle("hidden",!0);return}(async()=>{let a=n.content[t];if(a.type!=1)throw new Error("item type is not image");if(!a.src_id)throw new Error("src_id not found");r.src=await h(a.src_id,e.clientWidth),r.classList.toggle("hidden",!1)})()}function M(e,t){console.log(e);let n=document.createElement("li"),r=e.cloneNode(!0);if(!r)throw new Error("could not clone template");let i=r.content;return n.appendChild(i),t.appendChild(n),n}function X(e,t){let n=m();if(!n)throw new Error("could not load article");let r=e.querySelector(".paragraph-input");if(!r)throw new Error("Could not find textarea");let i=n.content[t];if(i.type!=0)throw new Error("Article item at index is not a paragraph");r.value=i.text,r.onchange=()=>{let l=m();if(!l)throw new Error("could not load article");let a=l.content[t];if(a.type!=0)throw new Error("Article item at index is not a paragraph");a.text=r.value,_(l)}}function Z(e,t){let n=m();if(!n)throw new Error("could not load article");let r=n.content[t];if(r.type!=1)throw new Error("Article item at index is not a image");let i=e.querySelector(".image-alt-text-input");if(!i)throw new Error("could not find alt_text element");i.value=r.alt_text,i.onchange=()=>{let o=m();if(!o)throw new Error("could not load article");let u=o.content[t];if(u.type!=1)throw new Error("Article item at index is not a image");u.alt_text=i.value,_(o)};let l=e.querySelector(".image-gallery-select"),a=e.querySelector(".image-gallery-upload");l&&(l.onclick=()=>$(t)),a&&(a.onclick=()=>Q(t))}function ee(e,t){let n=e.querySelector(".delete-button");n&&(n.onclick=()=>{te(t),g()});let r=e.querySelector(".move-up-button");r&&(r.onclick=()=>{A(t,-1),g()});let i=e.querySelector(".move-down-button");i&&(i.onclick=()=>{A(t,1),g()})}function g(){let e=m();if(!e)throw new Error("could not load article");let t=window.scrollY,n=F(),r=W();if(!n)throw new Error("Editor is not initialized");if(!r)throw new Error("templates did not load");n.innerHTML="";let i;for(let l=0;l<e.content.length;l++){switch(e.content[l].type){case 0:i=M(r.paragraph,n),X(i,l);break;case 1:i=M(r.image,n),V(i,l,e),Z(i,l);break;case 2:i=M(r.heading,n);break;default:console.log("Item type in editor-render is unknown, skipping");continue}ee(i,l)}_(e),requestAnimationFrame(()=>{window.scrollTo(0,t)})}function H(e){let t=m();if(!t)throw new Error("could not load artilce");let n=t.content.length,r;switch(e){case 0:case 2:r={type:e,text:"",index:n};break;case 1:r={type:e,alt_text:"",index:n,src_id:void 0};break}t.content.push(r),t.last_changed=c(),_(t),g()}function te(e){let t=m();if(!t)throw new Error("could not load article");return t.content.splice(e,1),t.last_changed=c(),_(t),t}function A(e,t){let n=m();if(!n)throw new Error("could not load article");let r=e+t;if(r<0||r>=n.content.length)throw new Error("target position is out of bounds");let[i]=n.content.splice(e,1);return n.content.splice(r,0,i),n.last_changed=c(),_(n),n}function I(){if(!p()){window.location.href="/";return}let t=m();t||(t=Y());let n=G();if(!n)throw new Error("controll buttons not initialized");n.log_button.onclick=()=>console.log(t),n.add_paragraph_button.onclick=()=>H(0),n.add_image_button.onclick=()=>H(1),n.add_heading_button.onclick=()=>H(2),g()}function ne(){let e=document.getElementById("gallery-image-preview-template"),t=document.getElementById("gallery-image-display");return!t||!e?null:{image_preview_template:e,image_display:t}}async function re(){let e=await d("/media/fetch_all_media_metadata",{});if(e.error)throw new Error(e.error);let t=e;return t.length>1&&t.sort((n,r)=>r.creation_time-n.creation_time),t=t.filter(n=>n&&n.id),t}async function k(){let e=ne();if(!e)throw new Error("Gallery HTML elements not initialized");let n=(await re()).map(async a=>({target:await h(a.id,e.image_display.clientWidth),media:a})),i=(await Promise.all(n)).map(a=>{let o=document.createElement("li"),s=e.image_preview_template.cloneNode(!0).content;o.appendChild(s);let w=o.querySelector("img");if(!w)throw new Error("could not find image element, something went wrong");return w.src=a.target,{entry:o,...a}}),l=await Promise.all(i);l.forEach(a=>{a.entry.onclick=()=>{window.opener.receive_data(a.media.id),window.close()}}),e.image_display.innerHTML="",l.forEach(a=>{e.image_display.appendChild(a.entry)})}window.addEventListener("load",e=>{window.location.pathname==="/editor"&&I(),window.location.pathname==="/gallery-popup"&&k(),E()});})();
//# sourceMappingURL=bundle.js.map
