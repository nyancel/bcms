"use strict";(()=>{var k="utilts-cache-stroage-key";function S(e){localStorage.setItem(k,JSON.stringify(e))}function v(){let e=localStorage.getItem(k);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("cache cant be parsed");return t}function C(e){let t=v();if(!t)return null;for(let n=0;n<t.length;n++)t[n].expires_at<u()&&t.splice(n,1);S(t);for(let n=0;n<t.length;n++)if(t[n].key==e)return t[n].item;return null}function N(e,t,n=3600){let r=v();r||(r=[]);let i={key:e,item:t,expires_at:u()+n};r.push(i),console.log(i),S(r)}function u(){return new Date().getTime()/1e3}async function c(e,t){return await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}async function x(e,t){console.log("called stuff");let n=await fetch(e,{method:"POST",body:t});console.log(n);let r=await n.json();return console.log(r),r}async function q(e,t){console.log("getting smallest item from res");let n=`util_get_media_src_by_width-${e}-${t}`,r=C(n);if(r)return r;let i=await c("/media/fetch_media",{media_ID:e}),a=Math.pow(t,2),l=await Promise.all(i.instances.map(o=>({id:o.instance_id,resolution:o.x_dimension*o.y_dimension})));l=l.sort((o,O)=>o.resolution-O.resolution);let s=l[l.length-1].id;for(let o of l)if(o.resolution>a){s=o.id;break}let m=`/media/fetch_media_instance?instance_ID=${s}`;return N(n,m),m}var y="userts-local-user-token",b="userts-local-user-data";function f(){let e=localStorage.getItem(y),t=localStorage.getItem(b);if(!e||!t)return null;let n=JSON.parse(e),r=JSON.parse(t);return!n||!r?null:{token:n,user:r}}function E(){localStorage.removeItem(b),localStorage.removeItem(y)}function h(e){let t=JSON.stringify(e.token),n=JSON.stringify(e.user);return localStorage.setItem(y,t),localStorage.setItem(b,n),!0}function D(){let e=document.querySelector(".user-details-login-template"),t=document.querySelector(".user-details-profile-template"),n=document.querySelector(".user-details-container");return!e||!t||!n?null:{login_template:e,profile_template:t,details_container:n}}function L(){let e=document.querySelector("#user-register-first-name-input"),t=document.querySelector("#user-register-last-name-input"),n=document.querySelector("#user-register-email-input"),r=document.querySelector("#user-register-password-input"),i=document.querySelector("#user-register-password-repeat-input"),a=document.querySelector("#user-register-submitt-button"),l=document.querySelector("#user-signin-email-input"),s=document.querySelector("#user-signin-password-input"),m=document.querySelector("#user-signin-submitt-button");return!e||!t||!n||!r||!i||!a||!l||!s||!m?null:{registration:{email:n,first_name:e,last_name:t,password:r,repeat_password:i,submit:a},signin:{email:l,password:s,submit:m}}}function j(){let e=f();if(!e)throw new Error("No local user-data");c("/user/logout",{user_token:e.token.id}),E(),g()}function J(){let e=D();if(!e)throw new Error("could not load html elements");e.details_container.innerHTML="";let t=f();if(!t){let s=e.login_template.cloneNode(!0);e.details_container.appendChild(s.content);return}let r=e.profile_template.cloneNode(!0).content,i=r.querySelector("#user-profile-first-name");if(!i)throw new Error("fistname_element not found");i.innerHTML=t.user.first_name;let a=r.querySelector("#user-profile-last-name");if(!a)throw new Error("lastname_element not found");a.innerHTML=t.user.last_name;let l=r.querySelector("#user-profile-logout-button");if(!l)throw new Error("logout_button not found");l.onclick=()=>{j()},e.details_container.appendChild(r)}function U(e,t){let n=L();if(!n)throw new Error("input fields not initialized");if(!e){n.registration.submit.innerHTML=t??"invalid registration-data",n.registration.submit.classList.toggle("bg-green-600",!1),n.registration.submit.classList.toggle("bg-gray-600",!0);return}n.registration.submit.innerHTML="Register",n.registration.submit.classList.toggle("bg-gray-600",!1),n.registration.submit.classList.toggle("bg-green-600",!0)}function T(e){let t=!0,n="";return e.registration.password.value!=e.registration.repeat_password.value&&(t=!1,n="passwords dont match"),e.registration.first_name.value||(t=!1,n="missing first name"),e.registration.email.value||(t=!1,n="missing email"),e.registration.last_name.value||(t=!1,n="missing last name"),e.registration.password.value||(t=!1,n="missing password"),{valid:t,reason:n}}function R(e){if(!T(e).valid)throw new Error("inputs are not valid");(async()=>{let n=L();if(!n)throw new Error("input fields not initialized");if(!T(n).valid)throw new Error("inputs are not valid");let r={email:n.registration.email.value,password:n.registration.password.value,firstname:n.registration.first_name.value,lastname:n.registration.last_name.value},i=await c("/user/register_new_user",r);if(i.error)throw new Error(i.error);let a={email:r.email,password:r.password},l=await c("/user/login",a);if(l.error)throw new Error(l.error);h({user:i,token:l}),window.location.href="/"})()}function _(e){let{valid:t,reason:n}=T(e);U(t,n)}function z(){let e=L();if(!e)throw new Error("inputs not initialized");e.registration.email.oninput=()=>_(e),e.registration.first_name.oninput=()=>_(e),e.registration.last_name.oninput=()=>_(e),e.registration.password.oninput=()=>_(e),e.registration.repeat_password.oninput=()=>_(e),e.registration.submit.onclick=()=>R(e),_(e)}async function K(){let e=f();if(!e)return null;if(u()>e.token.expires_at){E(),g();return}if(u()+600>e.token.expires_at){let n=await c("/user/refresh_token",{user_token:e.token.id});if(n.error)throw new Error(n.error);e.token=n,h(e)}let t=await c("/user/who",{user_token:e.token.id});if(t.error)if(t.error==="token invalid"){E(),g();return}else throw new Error(t.error);e.user=t,h(e)}function g(){K(),J(),window.location.pathname==="/signin"&&z()}var B="editor-ts-local-article";function p(){let e=localStorage.getItem(B);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("could not parse the local article, you fucked up somehow");return t}function w(e){let t=JSON.stringify(e);localStorage.setItem(B,t)}function Y(){let e=f();if(!e)throw new Error("no user data found, not logged in");let t={author_id:e.user.id,content:[],description:"",last_changed:u(),id:void 0,title:""};return w(t),t}function F(){let e=document.getElementById("log-article"),t=document.getElementById("add-paragraph"),n=document.getElementById("add-image"),r=document.getElementById("add-heading");return!e||!t||!n||!r?null:{log_button:e,add_paragraph_button:t,add_image_button:n,add_heading_button:r}}function G(){let e=document.getElementById("article-paragraph-template"),t=document.getElementById("article-image-template"),n=document.getElementById("article-heading-template");return!e||!t||!n?null:{paragraph:e,image:t,heading:n}}function P(){return document.getElementById("editor-container")}function W(e){let t=window.open("/gallery-popup","popupWindow","width=600,height=400");window.receive_data=function(n){let r=p();if(!r)throw new Error("could not load artilce");let i=r.content[e];i.type==1&&(i.src_id=n,d())}}function $(e){let t=document.createElement("input");t.type="file",t.accept="png, jpg, jpeg",t.multiple=!1,t.onchange=async()=>{let n=p();if(!n)throw new Error("could not load artilce");let r=n.content[e];if(r.type!=1)return;let i=t.files;if(!i)return;let l=Array.from(i)[0];t.remove();let s=new FormData;s.append("media",l);let o=(await x("/media/upload_media",s)).data.results[0].key;r.src_id=o,n.last_changed=u(),w(n),d()},t.click()}function Q(e,t,n){let r=e.querySelector(".image-display");if(!r)throw new Error("media-display not found");let i=n.content[t];if(i.type!=1)throw new Error("item type is not image");if(!i.src_id){r.classList.toggle("hidden",!0);return}(async()=>{let l=n.content[t];if(l.type!=1)throw new Error("item type is not image");if(!l.src_id)throw new Error("src_id not found");r.src=await q(l.src_id,e.clientWidth),r.classList.toggle("hidden",!1)})()}function M(e,t){console.log(e);let n=document.createElement("li"),r=e.cloneNode(!0);if(!r)throw new Error("could not clone template");let i=r.content;return n.appendChild(i),t.appendChild(n),n}function V(e,t,n){let r=e.querySelector(".paragraph-input");if(!r)throw new Error("Could not find textarea");let i=n.content[t];if(i.type!=0)throw new Error("Article item at index is not a paragraph");r.value=i.text,r.onchange=()=>{i.text=r.value}}function X(e,t,n){let r=e.querySelector(".image-alt-text-input");if(!r)throw new Error("could not find alt_text element");let i=n.content[t];if(i.type!=1)throw new Error("Article item at index is not a image");i.alt_text&&(r.value=i.alt_text),r.onchange=()=>{i.alt_text=r.value};let a=e.querySelector(".image-gallery-select"),l=e.querySelector(".image-gallery-upload");a&&(a.onclick=()=>W(t)),l&&(l.onclick=()=>$(t))}function Z(e,t){let n=e.querySelector(".delete-button");n&&(n.onclick=()=>{ee(t),d()});let r=e.querySelector(".move-up-button");r&&(r.onclick=()=>{A(t,-1),d()});let i=e.querySelector(".move-down-button");i&&(i.onclick=()=>{A(t,1),d()})}function d(){let e=p();if(!e)throw new Error("could not load article");let t=window.scrollY,n=P(),r=G();if(!n)throw new Error("Editor is not initialized");if(!r)throw new Error("templates did not load");n.innerHTML="";let i;for(let a=0;a<e.content.length;a++){switch(e.content[a].type){case 0:i=M(r.paragraph,n),V(i,a,e);break;case 1:i=M(r.image,n),Q(i,a,e),X(i,a,e);break;case 2:i=M(r.heading,n);break;default:console.log("Item type in editor-render is unknown, skipping");continue}Z(i,a)}w(e),requestAnimationFrame(()=>{window.scrollTo(0,t)})}function I(e){let t=p();if(!t)throw new Error("could not load artilce");let n=t.content.length,r;switch(e){case 0:case 2:r={type:e,text:"",index:n};break;case 1:r={type:e,alt_text:"",index:n,src_id:void 0};break}t.content.push(r),t.last_changed=u(),w(t),d()}function ee(e){let t=p();if(!t)throw new Error("could not load article");return t.content.splice(e,1),t.last_changed=u(),w(t),t}function A(e,t){let n=p();if(!n)throw new Error("could not load article");let r=e+t;if(r<0||r>=n.content.length)throw new Error("target position is out of bounds");let[i]=n.content.splice(e,1);return n.content.splice(r,0,i),n.last_changed=u(),w(n),n}function H(){if(!f()){window.location.href="/";return}let t=p();t||(t=Y());let n=F();if(!n)throw new Error("controll buttons not initialized");n.log_button.onclick=()=>console.log(t),n.add_paragraph_button.onclick=()=>I(0),n.add_image_button.onclick=()=>I(1),n.add_heading_button.onclick=()=>I(2),d()}window.addEventListener("load",e=>{window.location.pathname==="/editor"&&H(),g()});})();
//# sourceMappingURL=bundle.js.map
