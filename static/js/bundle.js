"use strict";(()=>{function o(){return new Date().getTime()/1e3}async function m(e,t){return await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}async function M(e,t){console.log("called stuff");let n=await fetch(e,{method:"POST",body:t});console.log(n);let r=await n.json();return console.log(r),r}var T="userts-local-user-token",w="userts-local-user-data";function s(){let e=localStorage.getItem(T),t=localStorage.getItem(w);if(!e||!t)return null;let n=JSON.parse(e),r=JSON.parse(t);return!n||!r?null:{token:n,user:r}}function _(){localStorage.removeItem(w),localStorage.removeItem(T)}function f(e){let t=JSON.stringify(e.token),n=JSON.stringify(e.user);return localStorage.setItem(T,t),localStorage.setItem(w,n),!0}function k(){let e=document.querySelector(".user-details-login-template"),t=document.querySelector(".user-details-profile-template"),n=document.querySelector(".user-details-container");return!e||!t||!n?null:{login_template:e,profile_template:t,details_container:n}}function h(){let e=document.querySelector("#user-register-first-name-input"),t=document.querySelector("#user-register-last-name-input"),n=document.querySelector("#user-register-email-input"),r=document.querySelector("#user-register-password-input"),i=document.querySelector("#user-register-password-repeat-input"),a=document.querySelector("#user-register-submitt-button"),l=document.querySelector("#user-signin-email-input"),u=document.querySelector("#user-signin-password-input"),p=document.querySelector("#user-signin-submitt-button");return!e||!t||!n||!r||!i||!a||!l||!u||!p?null:{registration:{email:n,first_name:e,last_name:t,password:r,repeat_password:i,submit:a},signin:{email:l,password:u,submit:p}}}function C(){let e=s();if(!e)throw new Error("No local user-data");m("/user/logout",{user_token:e.token.id}),_(),d()}function v(){let e=k();if(!e)throw new Error("could not load html elements");e.details_container.innerHTML="";let t=s();if(!t){let u=e.login_template.cloneNode(!0);e.details_container.appendChild(u.content);return}let r=e.profile_template.cloneNode(!0).content,i=r.querySelector("#user-profile-first-name");if(!i)throw new Error("fistname_element not found");i.innerHTML=t.user.first_name;let a=r.querySelector("#user-profile-last-name");if(!a)throw new Error("lastname_element not found");a.innerHTML=t.user.last_name;let l=r.querySelector("#user-profile-logout-button");if(!l)throw new Error("logout_button not found");l.onclick=()=>{C()},e.details_container.appendChild(r)}function R(e,t){let n=h();if(!n)throw new Error("input fields not initialized");if(!e){n.registration.submit.innerHTML=t??"invalid registration-data",n.registration.submit.classList.toggle("bg-green-600",!1),n.registration.submit.classList.toggle("bg-gray-600",!0);return}n.registration.submit.innerHTML="Register",n.registration.submit.classList.toggle("bg-gray-600",!1),n.registration.submit.classList.toggle("bg-green-600",!0)}function E(e){let t=!0,n="";return e.registration.password.value!=e.registration.repeat_password.value&&(t=!1,n="passwords dont match"),e.registration.first_name.value||(t=!1,n="missing first name"),e.registration.email.value||(t=!1,n="missing email"),e.registration.last_name.value||(t=!1,n="missing last name"),e.registration.password.value||(t=!1,n="missing password"),{valid:t,reason:n}}function x(e){if(!E(e).valid)throw new Error("inputs are not valid");(async()=>{let n=h();if(!n)throw new Error("input fields not initialized");if(!E(n).valid)throw new Error("inputs are not valid");let r={email:n.registration.email.value,password:n.registration.password.value,firstname:n.registration.first_name.value,lastname:n.registration.last_name.value},i=await m("/user/register_new_user",r);if(i.error)throw new Error(i.error);let a={email:r.email,password:r.password},l=await m("/user/login",a);if(l.error)throw new Error(l.error);f({user:i,token:l}),window.location.href="/"})()}function c(e){let{valid:t,reason:n}=E(e);R(t,n)}function q(){let e=h();if(!e)throw new Error("inputs not initialized");e.registration.email.oninput=()=>c(e),e.registration.first_name.oninput=()=>c(e),e.registration.last_name.oninput=()=>c(e),e.registration.password.oninput=()=>c(e),e.registration.repeat_password.oninput=()=>c(e),e.registration.submit.onclick=()=>x(e),c(e)}async function O(){let e=s();if(!e)return null;if(o()>e.token.expires_at){_(),d();return}if(o()+600>e.token.expires_at){let n=await m("/user/refresh_token",{user_token:e.token.id});if(n.error)throw new Error(n.error);e.token=n,f(e)}let t=await m("/user/who",{user_token:e.token.id});if(t.error)if(t.error==="token invalid"){_(),d();return}else throw new Error(t.error);e.user=t,f(e)}function d(){O(),v(),window.location.pathname==="/signin"&&q()}var H="editor-ts-local-article";function I(){let e=localStorage.getItem(H);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("could not parse the local article, you fucked up somehow");return t}function A(e){let t=JSON.stringify(e);localStorage.setItem(H,t)}function B(){let e=s();if(!e)throw new Error("no user data found, not logged in");let t={author_id:e.user.id,content:[],description:"",last_changed:o(),id:void 0,title:""};return A(t),t}function D(){let e=document.getElementById("log-article"),t=document.getElementById("add-paragraph"),n=document.getElementById("add-image"),r=document.getElementById("add-heading");return!e||!t||!n||!r?null:{log_button:e,add_paragraph_button:t,add_image_button:n,add_heading_button:r}}function N(e){let t=document.createElement("input");t.type="file",t.accept="png, jpg, jpeg",t.multiple=!1,t.onchange=async()=>{if(!ARTICLE.content)return;let n=ARTICLE.content[e];if(n.type!=1)return;let r=t.files;if(!r)return;let a=Array.from(r)[0];t.remove();let l=new FormData;l.append("media",a);let p=(await M("/media/upload_media",l)).data.results[0].key;n.src_id=p,ARTICLE.last_changed=o(),g()},t.click()}function L(e){if(console.log(e),!EDITOR)throw new Error("Editor has not been initalized");let t=document.createElement("li"),n=e.cloneNode(!0);if(!n)throw new Error("could not clone template");let r=n.content;return t.appendChild(r),EDITOR.appendChild(t),t}function z(e,t){let n=e.querySelector(".paragraph-input");if(!n)throw new Error("Could not find textarea");let r=ARTICLE.content[t];if(r.type!=0)throw new Error("Article item at index is not a paragraph");n.value=r.text,n.onchange=()=>{r.text=n.value}}function j(e,t){let n=e.querySelector(".image-alt-text-input");if(!n)throw new Error("could not find alt_text element");let r=ARTICLE.content[t];if(r.type!=1)throw new Error("Article item at index is not a image");r.alt_text&&(n.value=r.alt_text),n.onchange=()=>{r.alt_text=n.value};let i=e.querySelector(".image-gallery-select"),a=e.querySelector(".image-gallery-upload");i&&(i.onclick=()=>editor_gallery_pop_up_select(t)),a&&(a.onclick=()=>N(t))}function J(e,t){let n=e.querySelector(".delete-button");n&&(n.onclick=()=>{P(t),g()});let r=e.querySelector(".move-up-button");r&&(r.onclick=()=>{K(t),g()});let i=e.querySelector(".move-down-button");i&&(i.onclick=()=>{U(t),g()})}function g(){let e=window.scrollY;if(!EDITOR)throw new Error("Editor is not initialized");if(!ARTICLE)throw new Error("Article is not initialized");EDITOR.innerHTML="";let t;for(let n=0;n<ARTICLE.content.length;n++){switch(ARTICLE.content[n].type){case 0:if(!TEMPLATES.paragraph)throw new Error("paragraph template not initialized");t=L(TEMPLATES.paragraph),z(t,n);break;case 1:if(!TEMPLATES.image)throw new Error("image template not initialized");console.log("inserting image"),t=L(TEMPLATES.image),editor_image_render(t,n),j(t,n);break;case 2:if(!TEMPLATES.heading)throw new Error("image template not initialized");t=L(TEMPLATES.heading);break;default:console.log("Item type in editor-render is unknown, skipping");continue}J(t,n)}requestAnimationFrame(()=>{window.scrollTo(0,e)})}function y(e){if(!s())throw new Error("not logged in");let n=I();if(!n)throw new Error("article has not been initalized");let r=n.content.length,i;switch(e){case 0:case 2:i={type:e,text:"",index:r};break;case 1:i={type:e,alt_text:"",index:r,src_id:void 0};break}n.content.push(i),n.last_changed=o(),A(n),g()}function P(e){ARTICLE.content?.splice(e,1),ARTICLE.last_changed=o()}function U(e){if(!ARTICLE.content||e>=ARTICLE.content.length-1)return;let t=ARTICLE.content[e];ARTICLE.content[e]=ARTICLE.content[e+1],ARTICLE.content[e+1]=t,ARTICLE.content[e].index=e,ARTICLE.content[e+1].index=e+1,ARTICLE.last_changed=o()}function K(e){if(!ARTICLE.content||e<1)return;let t=ARTICLE.content[e];ARTICLE.content[e]=ARTICLE.content[e-1],ARTICLE.content[e-1]=t,ARTICLE.content[e].index=e,ARTICLE.content[e-1].index=e-1,ARTICLE.last_changed=o()}function Y(){let e=I();console.log(e)}function b(){if(!s()){window.location.href="/";return}let t=I();t||(t=B());let n=D();if(!n)throw new Error("controll buttons not initialized");n.log_button.onclick=()=>Y(),n.add_paragraph_button.onclick=()=>y(0),n.add_image_button.onclick=()=>y(1),n.add_heading_button.onclick=()=>y(2)}window.addEventListener("load",e=>{window.location.pathname==="/editor"&&b(),d()});})();
//# sourceMappingURL=bundle.js.map
