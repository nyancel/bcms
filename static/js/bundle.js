"use strict";(()=>{async function p(e,t){let r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=r.status,a=await r.json();return{time:a.time,message:a.message,data:a.data,success:a.success,status_code:n}}async function U(e,t){let n=await p("/user/login",{email:e,password:t});if(n.success==0)return{response:n};let a=n.data;return{response:n,token:a}}async function j(e){return{response:await p("/user/login",{auth_token:e})}}async function C(e,t,r,n){let i=await p("user/register",{email:e,password:t,firstname:r,lastname:n});if(i.success==0)return{response:i};let o=i.data;return{response:i,userdata:o}}async function R(e){let r=await p("/user/who",{auth_token:e});if(console.log(r),r.success==0)throw new Error(r.message);let n=r.data;return console.log(n),{response:r,userdata:n}}async function O(){let e=await p("/user/admin_test_creds",{});if(e.success==0)throw new Error(e.message);let t=e.data;return{response:e,admin:t}}var y="BCMS_USERTS_LOCALTOKEN",L="BCMS_USERTS_LOCALUSER";function d(){let e=localStorage.getItem(y),t=localStorage.getItem(L);if(!e||!t)return null;let r=JSON.parse(e),n=JSON.parse(t);return!r||!n?null:{token:r,user:n}}function N(){return localStorage.removeItem(L),localStorage.removeItem(y),!0}function M(e){let t=JSON.stringify(e.token),r=JSON.stringify(e.user);return localStorage.setItem(y,t),localStorage.setItem(L,r),!0}async function P(){let e=await O();if(console.log(e),!e.admin)throw new Error(e.response.message);let t=await R(e.admin.id);if(console.log(t),!t.userdata)throw new Error(t.response.message);let r={token:e.admin,user:t.userdata};return M(r),r}var J="utilts-cache-stroage-key";function G(e){localStorage.setItem(J,JSON.stringify(e))}function $(){let e=localStorage.getItem(J);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("cache cant be parsed");return t}function ne(e){let t=$();if(!t)return null;for(let r=0;r<t.length;r++)t[r].expires_at<E()&&t.splice(r,1);G(t);for(let r=0;r<t.length;r++)if(t[r].key==e)return t[r].item;return null}function ae(e,t,r=3600){let n=$();n||(n=[]);let a={key:e,item:t,expires_at:E()+r};n.push(a),console.log(a),G(n)}function E(){return new Date().getTime()/1e3}async function c(e,t){let r=d();return r&&(t.auth_token=r.token.id),await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}async function K(e,t){let r=d();r&&t.append("auth_token",r?.token.id);let n=await fetch(e,{method:"POST",body:t});console.log(n);let a=await n.json();return console.log(a),a}async function T(e,t){console.log("getting smallest item from res");let r=`util_get_media_src_by_width-${e}-${t}`,n=ne(r);if(n)return n;let a=await c("/media/fetch_media",{media_ID:e}),i=Math.pow(t,2),o=await Promise.all(a.instances.map(s=>({id:s.instance_id,resolution:s.x_dimension*s.y_dimension})));o=o.sort((s,m)=>s.resolution-m.resolution);let l=o[o.length-1].id;for(let s of o)if(s.resolution>i){l=s.id;break}let u=`/media/fetch_media_instance?instance_ID=${l}`;return ae(r,u),u}function ie(){let e=document.getElementById("gallery-image-preview-template"),t=document.getElementById("gallery-image-display");return!t||!e?null:{image_preview_template:e,image_display:t}}async function oe(){let e=await c("/media/fetch_all_media_metadata",{});if(e.error)throw new Error(e.error);let t=e;return t.length>1&&t.sort((r,n)=>n.creation_time-r.creation_time),t=t.filter(r=>r&&r.id),t}async function b(){let e=ie();if(!e)throw new Error("Gallery HTML elements not initialized");let r=(await oe()).map(async o=>({target:await T(o.id,e.image_display.clientWidth),media:o})),a=(await Promise.all(r)).map(o=>{let l=document.createElement("li"),s=e.image_preview_template.cloneNode(!0).content;l.appendChild(s);let m=l.querySelector("img");if(!m)throw new Error("could not find image element, something went wrong");return m.src=o.target,{entry:l,...o}}),i=await Promise.all(a);i.forEach(o=>{o.entry.onclick=()=>{window.opener.receive_data(o.media.id),window.close()}}),e.image_display.innerHTML="",i.forEach(o=>{e.image_display.appendChild(o.entry)})}function le(){let e=document.getElementById("image-upload-source"),t=document.getElementById("gallery-image-preview-template"),r=document.getElementById("gallery-image-display"),n=document.getElementById("upload-image-button");return!e||!t||!r||!n?null:{input_source:e,image_preview_template:t,image_display:r,upload_button:n}}async function se(e){let t=await c("/media/fetch_all_media_metadata",{});if(console.log(t),t.error)throw new Error(t.error);if(t.success==0)return null;let r=t;if(console.log(r),r.length<=0)throw new Error("no media found");r=r.filter(i=>i&&i.id);let n=r.map(async i=>{let o=await T(i.id,e.image_display.clientWidth);return{media:i,target_url:o}}),a=await Promise.all(n);return a.length>1&&a.sort((i,o)=>o.media.creation_time-i.media.creation_time),a}async function ue(e){let t=e.files;if(!t)throw new Error("no files attached to input source");let r=new FormData;for(let n=0;n<=t.length;n++)r.append("media",t[n]);await K("/media/upload_media",r),f(),e.value=""}async function me(e){let t=await se(e);if(!t){e.image_display.innerHTML="";return}let r=t.map(a=>{let i=document.createElement("li"),l=e.image_preview_template.cloneNode(!0).content;i.append(l);let u=i.querySelector("img");if(!u)throw new Error("could not find img element");return u.src=a.target_url,{entry:i,media:a}}),n=await Promise.all(r);n.forEach(a=>{let i=a.entry.querySelector(".remove-image-button");if(!i)throw new Error("could not find remove media button");i.onclick=async()=>{await c("/media/update_media_metadata",{media_ID:a.media.media.id,is_unlisted:!0}),f()}}),e.image_display.innerHTML="",n.forEach(a=>e.image_display.appendChild(a.entry))}function f(){let e=le();if(!e)throw new Error("html_elements not loaded");e.upload_button.onclick=()=>ue(e.input_source),me(e)}var Y=document.querySelector("#list-article-template"),H=document.querySelector("#list-article-display");function S(){z()}function ce(e){if(!H)throw new Error("Display list_article not found");if(!Y)throw new Error("Template is not found");H.innerHTML="";for(let t=0;t<e.length;t++){let n=Y.cloneNode(!0).content,a=n.querySelector(".list-article-title");if(!a)throw new Error("title not found");if(a.innerHTML=e[t].title,e[t].image.src_id){let u=n.querySelector(".list-article-image"),s=e[t].image.src_id;u&&(u.src=s)}let i=n.querySelector(".list-article-desc");if(!i)throw new Error("title not found");i.innerHTML=e[t].desc;let o=n.querySelector(".list-article-user_id");if(!o)throw new Error("title not found");o.innerHTML=e[t].user_id;let l=n.querySelector(".list-article-link");if(!l)throw new Error("entry element not found");l.onclick=()=>{window.location.href=`/view?article-id=${e[t].id}`},H.appendChild(n)}}async function z(){let e=await c("/article/list_all_articles",{});if("error"in e)throw new Error(e.error);ce(e),window.setTimeout(()=>{z()},1e3*60*10)}var _=document.querySelector("#article-display"),F=document.querySelector("#article-image"),W=document.querySelector("#article-title"),X=document.querySelector("#article-metadata"),Q=document.querySelector("#article-desc"),V=document.querySelector("#article-text");function I(){let t=new URLSearchParams(window.location.search).get("article-id");if(t==null)throw new Error("Article not found!");_e(t)}function de(e){if(!_)throw new Error("Display_article not found");if(!F)throw new Error("Template IMAGE is not found");if(!W)throw new Error("Template TITLE is not found");if(!X)throw new Error("Template METADATA is not found");if(!Q)throw new Error("Template DESC is not found");if(!V)throw new Error("Template TEXT is not found");_.innerHTML="";let t=W.cloneNode(!0),r=t.content,n=r.querySelector(".article-title");if(!n)throw new Error("title not found");n.innerHTML=e.title,_.append(r),t=Q.cloneNode(!0),r=t.content;let a=r.querySelector(".article-desc");if(!a)throw new Error("description not found!");a.innerHTML=e.desc,_.append(r),t=X.cloneNode(!0),r=t.content;let i=r.querySelector(".article-timestamp");if(!i)throw new Error("created timestamp not found");let o=new Date(0);o.setUTCSeconds(e.timestamp),i.innerHTML=`Skrevet: ${o.toLocaleString()}`;let l=r.querySelector(".article-update-timestamp");if(!l)throw new Error("update timestamp not found");let u=new Date(0);u.setUTCSeconds(e.update_timestamp),l.innerHTML=`Oppdatert: ${u.toLocaleString()}`;let s=r.querySelector(".article-author");if(!s)throw new Error("author not found");s.innerHTML=`Skrevet av ${e.user_id}`,_.append(r);for(let m=0;m<e.body.length;m++)switch(e.body[m].type){case"image":t=F.cloneNode(!0),r=t.content;let D=r.querySelector(".article-image"),te=e.body[m].src_id;D&&(D.src=te),_.appendChild(r);break;case"paragraph":t=V.cloneNode(!0),r=t.content;let q=r.querySelector(".article-text");if(!q)throw new Error("text not found");q.innerHTML=e.body[m].text,_.appendChild(r);break}}async function _e(e){let t=await c("/article/get_article",{id:e});if("error"in t)throw new Error(t.error);console.log(t),de(t)}function pe(){let e=document.querySelector(".user-details-login-template"),t=document.querySelector(".user-details-profile-template"),r=document.querySelector(".user-details-container");return!e||!t||!r?null:{login_template:e,profile_template:t,details_container:r}}function ge(){let e=d();if(!e)throw new Error("No local user-data");j(e.token.id),N(),k()}function fe(){let e=pe();if(!e)throw new Error("could not load html elements");e.details_container.innerHTML="";let t=d();if(!t){let l=e.login_template.cloneNode(!0);e.details_container.appendChild(l.content);return}let n=e.profile_template.cloneNode(!0).content,a=n.querySelector("#user-profile-first-name");if(!a)throw new Error("fistname_element not found");a.innerHTML=t.user.firstname;let i=n.querySelector("#user-profile-last-name");if(!i)throw new Error("lastname_element not found");i.innerHTML=t.user.lastname;let o=n.querySelector("#user-profile-logout-button");if(!o)throw new Error("logout_button not found");o.onclick=()=>{ge()},e.details_container.appendChild(n)}async function k(){await P(),fe()}function v(){let e=document.querySelector("#user-register-first-name-input"),t=document.querySelector("#user-register-last-name-input"),r=document.querySelector("#user-register-email-input"),n=document.querySelector("#user-register-password-input"),a=document.querySelector("#user-register-password-repeat-input"),i=document.querySelector("#user-register-submitt-button"),o=document.querySelector("#user-signin-email-input"),l=document.querySelector("#user-signin-password-input"),u=document.querySelector("#user-signin-submitt-button");return!e||!t||!r||!n||!a||!i||!o||!l||!u?null:{registration:{email:r,first_name:e,last_name:t,password:n,repeat_password:a,submit:i},signin:{email:o,password:l,submit:u}}}function we(e,t){let r=v();if(!r)throw new Error("input fields not initialized");if(!e){r.registration.submit.innerHTML=t??"invalid registration-data",r.registration.submit.classList.toggle("bg-green-600",!1),r.registration.submit.classList.toggle("bg-gray-600",!0);return}r.registration.submit.innerHTML="Register",r.registration.submit.classList.toggle("bg-gray-600",!1),r.registration.submit.classList.toggle("bg-green-600",!0)}function x(e){let t=!0,r="";return e.registration.password.value!=e.registration.repeat_password.value&&(t=!1,r="passwords dont match"),e.registration.first_name.value||(t=!1,r="missing first name"),e.registration.email.value||(t=!1,r="missing email"),e.registration.last_name.value||(t=!1,r="missing last name"),e.registration.password.value||(t=!1,r="missing password"),{valid:t,reason:r}}function Ee(e){if(!x(e).valid)throw new Error("inputs are not valid");(async()=>{let r=v();if(!r)throw new Error("input fields not initialized");if(!x(r).valid)throw new Error("inputs are not valid");let n=await C(r.registration.email.value,r.registration.password.value,r.registration.first_name.value,r.registration.last_name.value);if(!n.userdata)throw new Error(n.response.message);let a=await U(r.registration.email.value,r.registration.password.value);if(!a.token)throw new Error(a.response.message);let i={token:a.token,user:n.userdata};M(i),window.location.href="/"})()}function g(e){let{valid:t,reason:r}=x(e);we(t,r)}function Z(){let e=v();if(!e)throw new Error("inputs not initialized");e.registration.email.oninput=()=>g(e),e.registration.first_name.oninput=()=>g(e),e.registration.last_name.oninput=()=>g(e),e.registration.password.oninput=()=>g(e),e.registration.repeat_password.oninput=()=>g(e),e.registration.submit.onclick=()=>Ee(e),g(e)}var Te="BCMS_EDITORTS_LOCAL_DRAFTS";function ee(){let e=localStorage.getItem(Te);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("could not parse the local drafts, you fucked up somehow");return t}function A(){let e=ee();console.log("editor draft view")}window.addEventListener("load",e=>{switch(k(),window.location.pathname){case"/editor":if(new URLSearchParams(window.location.search).get("draft-id")==null){console.log("no draft chosen"),A();break}break;case"/gallery-popup":b();break;case"/gallery":f();break;case"/view":I();break;case"/signin":Z();break;case"/":S();break;default:break}});})();
//# sourceMappingURL=bundle.js.map
