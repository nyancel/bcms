"use strict";(()=>{var S="utilts-cache-stroage-key";function v(e){localStorage.setItem(S,JSON.stringify(e))}function A(){let e=localStorage.getItem(S);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("cache cant be parsed");return t}function B(e){let t=A();if(!t)return null;for(let n=0;n<t.length;n++)t[n].expires_at<c()&&t.splice(n,1);v(t);for(let n=0;n<t.length;n++)if(t[n].key==e)return t[n].item;return null}function D(e,t,n=3600){let r=A();r||(r=[]);let l={key:e,item:t,expires_at:c()+n};r.push(l),console.log(l),v(r)}function c(){return new Date().getTime()/1e3}async function d(e,t){let n=p();return n&&(t.auth_token=n.token.id),await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}async function x(e,t){let n=p();n&&t.append("auth_token",n?.token.id);let r=await fetch(e,{method:"POST",body:t});console.log(r);let l=await r.json();return console.log(l),l}async function h(e,t){console.log("getting smallest item from res");let n=`util_get_media_src_by_width-${e}-${t}`,r=B(n);if(r)return r;let l=await d("/media/fetch_media",{media_ID:e}),a=Math.pow(t,2),i=await Promise.all(l.instances.map(s=>({id:s.instance_id,resolution:s.x_dimension*s.y_dimension})));i=i.sort((s,w)=>s.resolution-w.resolution);let o=i[i.length-1].id;for(let s of i)if(s.resolution>a){o=s.id;break}let u=`/media/fetch_media_instance?instance_ID=${o}`;return D(n,u),u}var T="userts-local-user-token",b="userts-local-user-data";function p(){let e=localStorage.getItem(T),t=localStorage.getItem(b);if(!e||!t)return null;let n=JSON.parse(e),r=JSON.parse(t);return!n||!r?null:{token:n,user:r}}function U(){localStorage.removeItem(b),localStorage.removeItem(T)}function q(e){let t=JSON.stringify(e.token),n=JSON.stringify(e.user);return localStorage.setItem(T,t),localStorage.setItem(b,n),!0}function N(){let e=document.querySelector(".user-details-login-template"),t=document.querySelector(".user-details-profile-template"),n=document.querySelector(".user-details-container");return!e||!t||!n?null:{login_template:e,profile_template:t,details_container:n}}function L(){let e=document.querySelector("#user-register-first-name-input"),t=document.querySelector("#user-register-last-name-input"),n=document.querySelector("#user-register-email-input"),r=document.querySelector("#user-register-password-input"),l=document.querySelector("#user-register-password-repeat-input"),a=document.querySelector("#user-register-submitt-button"),i=document.querySelector("#user-signin-email-input"),o=document.querySelector("#user-signin-password-input"),u=document.querySelector("#user-signin-submitt-button");return!e||!t||!n||!r||!l||!a||!i||!o||!u?null:{registration:{email:n,first_name:e,last_name:t,password:r,repeat_password:l,submit:a},signin:{email:i,password:o,submit:u}}}function j(){let e=p();if(!e)throw new Error("No local user-data");d("/user/logout",{user_token:e.token.id}),U(),E()}function J(){let e=N();if(!e)throw new Error("could not load html elements");e.details_container.innerHTML="";let t=p();if(!t){let o=e.login_template.cloneNode(!0);e.details_container.appendChild(o.content);return}let r=e.profile_template.cloneNode(!0).content,l=r.querySelector("#user-profile-first-name");if(!l)throw new Error("fistname_element not found");l.innerHTML=t.user.first_name;let a=r.querySelector("#user-profile-last-name");if(!a)throw new Error("lastname_element not found");a.innerHTML=t.user.last_name;let i=r.querySelector("#user-profile-logout-button");if(!i)throw new Error("logout_button not found");i.onclick=()=>{j()},e.details_container.appendChild(r)}function R(e,t){let n=L();if(!n)throw new Error("input fields not initialized");if(!e){n.registration.submit.innerHTML=t??"invalid registration-data",n.registration.submit.classList.toggle("bg-green-600",!1),n.registration.submit.classList.toggle("bg-gray-600",!0);return}n.registration.submit.innerHTML="Register",n.registration.submit.classList.toggle("bg-gray-600",!1),n.registration.submit.classList.toggle("bg-green-600",!0)}function y(e){let t=!0,n="";return e.registration.password.value!=e.registration.repeat_password.value&&(t=!1,n="passwords dont match"),e.registration.first_name.value||(t=!1,n="missing first name"),e.registration.email.value||(t=!1,n="missing email"),e.registration.last_name.value||(t=!1,n="missing last name"),e.registration.password.value||(t=!1,n="missing password"),{valid:t,reason:n}}function z(e){if(!y(e).valid)throw new Error("inputs are not valid");(async()=>{let n=L();if(!n)throw new Error("input fields not initialized");if(!y(n).valid)throw new Error("inputs are not valid");let r={email:n.registration.email.value,password:n.registration.password.value,firstname:n.registration.first_name.value,lastname:n.registration.last_name.value},l=await d("/user/register_new_user",r);if(l.error)throw new Error(l.error);let a={email:r.email,password:r.password},i=await d("/user/login",a);if(i.error)throw new Error(i.error);q({user:l,token:i}),window.location.href="/"})()}function f(e){let{valid:t,reason:n}=y(e);R(t,n)}function K(){let e=L();if(!e)throw new Error("inputs not initialized");e.registration.email.oninput=()=>f(e),e.registration.first_name.oninput=()=>f(e),e.registration.last_name.oninput=()=>f(e),e.registration.password.oninput=()=>f(e),e.registration.repeat_password.oninput=()=>f(e),e.registration.submit.onclick=()=>z(e),f(e)}async function P(){let e=await d("/user/admin_test_creds",{}),t=await d("/user/who",{user_token:e.id});q({token:e,user:t})}function E(){P(),J(),window.location.pathname==="/signin"&&K()}var O="editor-ts-local-article";function m(){let e=localStorage.getItem(O);if(!e)return null;let t=JSON.parse(e);if(!t)throw new Error("could not parse the local article, you fucked up somehow");return t}function _(e){let t=JSON.stringify(e);localStorage.setItem(O,t)}function Y(){let e=p();if(!e)throw new Error("no user data found, not logged in");let t={author_id:e.user.id,content:[],description:"",last_changed:c(),id:void 0,title:""};return _(t),t}function G(){let e=document.getElementById("log-article"),t=document.getElementById("add-paragraph"),n=document.getElementById("add-image"),r=document.getElementById("add-heading");return!e||!t||!n||!r?null:{log_button:e,add_paragraph_button:t,add_image_button:n,add_heading_button:r}}function W(){let e=document.getElementById("article-paragraph-template"),t=document.getElementById("article-image-template"),n=document.getElementById("article-heading-template");return!e||!t||!n?null:{paragraph:e,image:t,heading:n}}function F(){return document.getElementById("editor-container")}function $(e){let t=window.open("/gallery-popup","popupWindow","width=600,height=400");window.receive_data=function(n){console.log(n);let r=m();if(!r)throw new Error("could not load artilce");let l=r.content[e];l.type==ArticleItemTypeEnum.image&&(l.src_id=n,_(r),g())}}function Q(e){let t=document.createElement("input");t.type="file",t.accept="png, jpg, jpeg",t.multiple=!1,t.onchange=async()=>{let n=m();if(!n)throw new Error("could not load artilce");let r=n.content[e];if(r.type!=ArticleItemTypeEnum.image)return;let l=t.files;if(!l)return;let i=Array.from(l)[0];t.remove();let o=new FormData;o.append("media",i);let s=(await x("/media/upload_media",o)).data.results[0].key;r.src_id=s,n.last_changed=c(),_(n),g()},t.click()}function V(e,t,n){let r=e.querySelector(".image-display");if(!r)throw new Error("media-display not found");let l=n.content[t];if(l.type!=ArticleItemTypeEnum.image)throw new Error("item type is not image");if(!l.src_id){r.classList.toggle("hidden",!0);return}(async()=>{let i=n.content[t];if(i.type!=ArticleItemTypeEnum.image)throw new Error("item type is not image");if(!i.src_id)throw new Error("src_id not found");r.src=await h(i.src_id,e.clientWidth),r.classList.toggle("hidden",!1)})()}function I(e,t){console.log(e);let n=document.createElement("li"),r=e.cloneNode(!0);if(!r)throw new Error("could not clone template");let l=r.content;return n.appendChild(l),t.appendChild(n),n}function X(e,t){let n=m();if(!n)throw new Error("could not load article");let r=e.querySelector(".paragraph-input");if(!r)throw new Error("Could not find textarea");let l=n.content[t];if(l.type!=ArticleItemTypeEnum.paragraph)throw new Error("Article item at index is not a paragraph");r.value=l.text,r.onchange=()=>{let a=m();if(!a)throw new Error("could not load article");let i=a.content[t];if(i.type!=ArticleItemTypeEnum.paragraph)throw new Error("Article item at index is not a paragraph");i.text=r.value,_(a)}}function Z(e,t){let n=m();if(!n)throw new Error("could not load article");let r=n.content[t];if(r.type!=ArticleItemTypeEnum.image)throw new Error("Article item at index is not a image");let l=e.querySelector(".image-alt-text-input");if(!l)throw new Error("could not find alt_text element");l.value=r.alt_text,l.onchange=()=>{let o=m();if(!o)throw new Error("could not load article");let u=o.content[t];if(u.type!=ArticleItemTypeEnum.image)throw new Error("Article item at index is not a image");u.alt_text=l.value,_(o)};let a=e.querySelector(".image-gallery-select"),i=e.querySelector(".image-gallery-upload");a&&(a.onclick=()=>$(t)),i&&(i.onclick=()=>Q(t))}function ee(e,t){let n=e.querySelector(".delete-button");n&&(n.onclick=()=>{te(t),g()});let r=e.querySelector(".move-up-button");r&&(r.onclick=()=>{C(t,-1),g()});let l=e.querySelector(".move-down-button");l&&(l.onclick=()=>{C(t,1),g()})}function g(){let e=m();if(!e)throw new Error("could not load article");let t=window.scrollY,n=F(),r=W();if(!n)throw new Error("Editor is not initialized");if(!r)throw new Error("templates did not load");n.innerHTML="";let l;for(let a=0;a<e.content.length;a++){switch(e.content[a].type){case ArticleItemTypeEnum.paragraph:l=I(r.paragraph,n),X(l,a);break;case ArticleItemTypeEnum.image:l=I(r.image,n),V(l,a,e),Z(l,a);break;case ArticleItemTypeEnum.heading:l=I(r.heading,n);break;default:console.log("Item type in editor-render is unknown, skipping");continue}ee(l,a)}_(e),requestAnimationFrame(()=>{window.scrollTo(0,t)})}function H(e){let t=m();if(!t)throw new Error("could not load artilce");let n=t.content.length,r;switch(e){case ArticleItemTypeEnum.paragraph:case ArticleItemTypeEnum.heading:r={type:e,text:"",index:n};break;case ArticleItemTypeEnum.image:r={type:e,alt_text:"",index:n,src_id:void 0};break}t.content.push(r),t.last_changed=c(),_(t),g()}function te(e){let t=m();if(!t)throw new Error("could not load article");return t.content.splice(e,1),t.last_changed=c(),_(t),t}function C(e,t){let n=m();if(!n)throw new Error("could not load article");let r=e+t;if(r<0||r>=n.content.length)throw new Error("target position is out of bounds");let[l]=n.content.splice(e,1);return n.content.splice(r,0,l),n.last_changed=c(),_(n),n}function M(){if(!p()){window.location.href="/";return}let t=m();t||(t=Y());let n=G();if(!n)throw new Error("controll buttons not initialized");n.log_button.onclick=()=>console.log(t),n.add_paragraph_button.onclick=()=>H(ArticleItemTypeEnum.paragraph),n.add_image_button.onclick=()=>H(ArticleItemTypeEnum.image),n.add_heading_button.onclick=()=>H(ArticleItemTypeEnum.heading),g()}function ne(){let e=document.getElementById("gallery-image-preview-template"),t=document.getElementById("gallery-image-display");return!t||!e?null:{image_preview_template:e,image_display:t}}async function re(){let e=await d("/media/fetch_all_media_metadata",{});if(e.error)throw new Error(e.error);let t=e;return t.length>1&&t.sort((n,r)=>r.creation_time-n.creation_time),t=t.filter(n=>n&&n.id),t}async function k(){let e=ne();if(!e)throw new Error("Gallery HTML elements not initialized");let n=(await re()).map(async i=>({target:await h(i.id,e.image_display.clientWidth),media:i})),l=(await Promise.all(n)).map(i=>{let o=document.createElement("li"),s=e.image_preview_template.cloneNode(!0).content;o.appendChild(s);let w=o.querySelector("img");if(!w)throw new Error("could not find image element, something went wrong");return w.src=i.target,{entry:o,...i}}),a=await Promise.all(l);a.forEach(i=>{i.entry.onclick=()=>{window.opener.receive_data(i.media.id),window.close()}}),e.image_display.innerHTML="",a.forEach(i=>{e.image_display.appendChild(i.entry)})}window.addEventListener("load",e=>{window.location.pathname==="/editor"&&M(),window.location.pathname==="/gallery-popup"&&k(),E()});})();
//# sourceMappingURL=bundle.js.map
